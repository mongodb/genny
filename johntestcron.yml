command_type: test
stepback: true
ignore:
  - "*.md" # don't schedule tests if a commit only changes markdown files
  - ".github/*" # github CODEOWNERS configuration

#######################################
#              Functions              #
#######################################
functions:
  get-project-and-modules:
    - command: git.get_project
      type: setup
      params:
        directory: evergreen
        token: ${github_token}
        shallow_clone: true
    - command: shell.exec
      type: setup
      params:
        working_dir: evergreen
        include_expansions_in_env: ["GOROOT"]
        shell: bash
        script: |
          # Downloading modules is flaky in the ubuntu1604-arm64 distros, because the TCP connection is sometimes reset
          # by the peer for unknown reasons (this does not happen in other distros). Retry the module download multiple
          # times to reduce the flakiness.
          for i in {1..5}; do
            make mod-tidy;
            [[ $? -eq 0 ]] && break;
          done

#######################################
#                Tasks                #
#######################################

tasks:
  - name: nonactive
    commands:
      - command: shell.exec
        params:
          script: echo inactive 
  - name: activated
    commands:
      - command: shell.exec
        params:
          script: echo inactive 
  - name: testcronactive
    commands:
      - command: git.get_project
        params:
          directory: src
      - command: generate.tasks
        params:
          files:
            - src/activetasks.json
  - name: testcronnonactive
    commands:
      - command: git.get_project
        params:
          directory: src
      - command: generate.tasks
        params:
          files:
            - src/nonactivetasks.json
  - name: gentestcronexternal
    commands:
      - command: git.get_project
        params:
          directory: src
      - command: generate.tasks
        params:
          files:
            - src/externaltasks.json

#######################################
#            Buildvariants            #
#######################################
buildvariants:
  - name: activatedvariant
    display_name: Activated
    run_on:
      - ubuntu2204-small
      - ubuntu2204-large
    cron: "*/15 * * * *"
    tasks:
      - name: nonactive
      - name: activated
        activate: true
      - name: testcronactive
        activate: true
  - name: notactivatedvariant
    display_name: Not Activated
    run_on:
      - ubuntu2204-small
      - ubuntu2204-large
    cron: "*/15 * * * *"
    tasks:
      - name: nonactive
      - name: testcronnonactive
        activate: true
  - name: notactivatedexternalgen
    display_name: Not Activated External Gen
    run_on:
      - ubuntu2204-small
      - ubuntu2204-large
    tasks: 
      - name: nonactive
    cron: "*/15 * * * *"
  - name: genfornotactivated
    display_name: Gen For Not Activated
    run_on:
      - ubuntu2204-small
      - ubuntu2204-large
    tasks:
      - name: gentestcronexternal
        activate: true
 
