SchemaVersion: 2018-07-01
Owner: "@mongodb/sharding"
Description: |
  On a single shard cluster, compare the latency of single write commands without shard key on a sharded collection vs unsharded collection.

GlobalDefaults:
  Nop: &Nop {Nop: true}

  Database: &Database test
  # Collection0 is the default collection populated by the MonotonicSingleLoader.
  ShardedCollection: &ShardedCollection Collection0
  UnshardedCollection: &UnshardedCollection Collection1
  Namespace: &Namespace test.Collection0

  DocumentCount: &DocumentCount 10000  # Number of documents to insert and modify.
  BalancerWait: &BalancerWait "20 seconds"  # Wait out the 20 second delay between balancing rounds
  # with a little extra leeway for balancing to finish.

Actors:
- Name: CreateShardedCluster
  Type: AdminCommand
  Threads: 1
  Phases:
  - Repeat: 1
    Database: admin
    Operations:
    - OperationMetricsName: EnableSharding
      OperationName: AdminCommand
      OperationCommand:
        enableSharding: *Database
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: *Namespace
        key: {x: 1}
    - OperationMetricsName: BalancerStart
      OperationName: AdminCommand
      OperationCommand:
        balancerStart: 1
  - *Nop
  - *Nop
  - *Nop

# TODO PERF-3208: Enable Test.
# - Name: LoadInitialDataOnShardedCollection
#   Type: MonotonicSingleLoader
#   Threads: 1
#   Phases:
#   - *Nop
#   - Repeat: 1
#     SleepBefore: *BalancerWait
#     BatchSize: 1000
#     DocumentCount: *DocumentCount
#     Database: *Database
#     Document: {x: 0, y: 0, z: 0}
#   - *Nop
#   - *Nop

- Name: LoadInitialDataOnUnshardedCollection
  Type: MonotonicSingleLoader
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 1
    SleepBefore: *BalancerWait
    BatchSize: 1000
    DocumentCount: *DocumentCount
    Database: *Database
    Collection: *UnshardedCollection
    Document: {x: 1, y: 1, z: 1}
  - *Nop
  - *Nop

# TODO PERF-3208: Enable Test.
# - Name: CRUDOpsOnShardedCollection
#   Type: CrudActor
#   Threads: 1  # We want to use 1 thread to avoid updates throwing WriteConflict errors.
#   Phases:
#   - *Nop
#   - *Nop
#   - Repeat: *DocumentCount
#     Database: *Database
#     Collection: *ShardedCollection
#     Operations:
#     - OperationMetricsName: UpdateOneWithoutShardKeyShardedCollection
#       OperationName: updateOne
#       OperationCommand:
#         Filter: {y: 0}
#         Update: {$inc: {y: 1}}
#         Options:
#           WriteConcern:
#             Level: majority
#             TimeoutMillis: 5000
#   - Repeat: *DocumentCount
#     Database: *Database
#     Collection: *ShardedCollection
#     Operations:
#     - OperationMetricsName: DeleteWithoutShardKeyShardedCollection
#       OperationName: deleteOne
#       OperationCommand:
#         Filter: {z: 0}
#         Options:
#           WriteConcern:
#             Level: majority
#             TimeoutMillis: 5000

- Name: CRUDOpsOnUnshardedCollection
  Type: CrudActor
  Threads: 1  # We want to use 1 thread to avoid updates throwing WriteConflict errors.
  Phases:
  - *Nop
  - *Nop
  - Repeat: *DocumentCount
    Database: *Database
    Collection: *UnshardedCollection
    Operations:
    - OperationMetricsName: UpdateOneWithoutShardKeyUnshardedCollection
      OperationName: updateOne
      OperationCommand:
        Filter: {y: 1}
        Update: {$inc: {y: 1}}
        Options:
          WriteConcern:
            Level: majority
            TimeoutMillis: 5000
  - Repeat: *DocumentCount
    Database: *Database
    Collection: *UnshardedCollection
    Operations:
    - OperationMetricsName: DeleteWithoutShardKeyUnshardedCollection
      OperationName: deleteOne
      OperationCommand:
        Filter: {z: 1}
        Options:
          WriteConcern:
            Level: majority
            TimeoutMillis: 5000

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - shard
      - shard-lite
      - shard-lite-all-feature-flags
    branch_name:
      $neq:
      - v4.0
      - v4.2
      - v4.4
      - v5.0
