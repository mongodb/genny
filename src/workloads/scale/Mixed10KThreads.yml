SchemaVersion: 2018-07-01
Owner: "@mongodb/server-execution"
Description: |
  This workload consists of a situation where the server is being contacted by 10k different
  clients to simulate an extreme case of overload in the server. Both reads and writes happen
  at the same time in balanced fashion.

Keywords:
- scale
- insertMany
- find

dbname: &dbname mixed_10k
DocumentCount: &NumDocs 10000
CollectionCount: &NumColls 1

NumPhases: &NumPhases 2
Document: &doc
  a: {^RandomInt: {min: 0, max: *NumDocs}}
  b: {^RandomString: {length: 16}}
Clients:
  Default:
    QueryOptions:
      maxPoolSize: 10100

Actors:
- Name: Setup
  Type: Loader
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        # Have 10k documents ready at start
        Repeat: 1
        BatchSize: 100
        Threads: 1
        DocumentCount: *NumDocs
        Database: *dbname
        CollectionCount: *NumColls
        Document: *doc
        Indexes:
        - keys: {a: 1}

- Name: WritesActor
  Type: CrudActor
  Database: *dbname
  Threads: {^Parameter: {Name: "WritingThreads", Default: 5000}}
  Phases:
    - {Nop: true}
    - Repeat: 1
      GlobalRate: 1 per 10 milliseconds
      CollectionCount: *NumColls
      Operations:
      - OperationName: insertOne
        OperationMetricsName: Warmup
        OperationCommand:
          Document: *doc
        ThrowOnFailure: false
    - Duration: 3 minutes
      CollectionCount: *NumColls
      Operations:
      - OperationName: insertOne
        OperationMetricsName: WriteDocs
        OperationCommand:
          Document: *doc
        ThrowOnFailure: false

- Name: ReadsActor
  Type: CrudActor
  Database: *dbname
  Threads: {^Parameter: {Name: "ReadingThreads", Default: 5000}}
  Phases:
    - {Nop: true}
    - Repeat: 1
      GlobalRate: 1 per 10 milliseconds
      CollectionCount: *NumColls
      Operations:
      - OperationName: find
        OperationCommand:
          Filter: { a: { ^RandomInt: { min: 0, max: *NumDocs } } }
        OperationMetricsName: Warmup
        ThrowOnFailure: false
    - Duration: 3 minutes
      CollectionCount: *NumColls
      Operations:
      - OperationName: findOne
        OperationCommand:
          Filter: { a: { ^RandomInt: { min: 0, max: *NumDocs } } }
        OperationMetricsName: ReadDocs
        ThrowOnFailure: false

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - replica
      - replica-all-feature-flags
