SchemaVersion: 2018-07-01
Owner: "@mongodb/server-execution"
Description: |
  This workload tests the impact of background TTL deletions in a heavily modified collection with
  concurrent crud operations on a second collection to simulate extreme ticket contention.

Keywords:
- ttl
- stress
- indexes
- insertMany
- CrudActor

Clients:
  Default:
    QueryOptions:
      maxPoolSize: 10000

SmallDoc: &SmallDoc
  a: {^FastRandomString: {length: 123}}
  numField: {^RandomInt: {min: 0, max: 1000}}
  counter: 0
  expireDate: {^Date: "1970-01-01"}

LargeDoc: &LargeDoc
  a: {^FastRandomString: {length: 67890}}
  numField: {^RandomInt: {min: 0, max: 1000}}
  counter: 0
  expireDate: {^Date: "1970-01-01"}

Actors:
- Name: Setup
  Type: AdminCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: &NumPhases 3
      PhaseConfig:
        Repeat: 1
        Database: admin
        Operations:
        - OperationName: AdminCommand
          OperationCommand:
            setParameter: 1
            ttlMonitorSleepSecs: 1
        - OperationName: AdminCommand
          OperationCommand:
            setParameter: 1
            # Reduce tickets to force contention.
            storageEngineConcurrentWriteTransactions: 32
        SleepAfter: 60 seconds  # Wait 60 seconds so that the new ttl sleep config is active.

- Name: InsertData
  Type: Loader
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        Repeat: 1
        Database: &db test
        Threads: 1
        CollectionCount: &NumColls 1
        DocumentCount: 1
        BatchSize: 1
        Document: *SmallDoc
        Indexes:
        - keys: {expireDate: 1}
          options: {expireAfterSeconds: 0}
        - keys: {numField: 1}

- Name: CreateIndexes
  Type: RunCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        Repeat: 1
        Database: *db
        Operations:
        - OperationMetricsName: CreateNumFieldIndex
          OperationName: RunCommand
          OperationCommand:
            createIndexes: &otherColl otherColl
            indexes:
            - key:
                numField: 1
              name: numField
        - OperationMetricsName: CreateStringFieldIndex
          OperationName: RunCommand
          OperationCommand:
            createIndexes: *otherColl
            indexes:
            - key:
                a: 1
              name: string

- Name: Quiesce
  Type: QuiesceActor
  Database: *db
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [2]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        Threads: 1
        Repeat: 1

- Name: UpdateOtherColl
  Type: CrudActor
  Database: *db
  Threads: &numThreads 50
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        Duration: &phaseDuration 10 minutes
        Collection: *otherColl
        Operations:
        - OperationName: updateOne
          OperationCommand:
            Filter: &filter
              numField: {^RandomInt: {min: 0, max: 1000}}
            Update:
              $inc: {counter: 1}

- Name: RemoveOtherColl
  Type: CrudActor
  Database: *db
  Threads: *numThreads
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        Duration: *phaseDuration
        Collection: *otherColl
        Operations:
        - OperationName: deleteOne
          OperationCommand:
            Filter: *filter

- Name: InsertOtherCollSmall
  Type: CrudActor
  Database: *db
  Threads: &halfThreads 25
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        Duration: *phaseDuration
        Collection: *otherColl
        Operations:
        - OperationName: insertOne
          OperationCommand:
            Document: *SmallDoc

- Name: InsertOtherCollLarge
  Type: CrudActor
  Database: *db
  Threads: *halfThreads
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        Duration: *phaseDuration
        Collection: *otherColl
        Operations:
        - OperationName: insertOne
          OperationCommand:
            Document: *LargeDoc

- Name: InsertTTLColl-Small
  Type: CrudActor
  Database: *db
  Threads: 300
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        Duration: *phaseDuration
        Collection: Collection0
        Operations:
        - OperationName: insertOne
          OperationCommand:
            Document: *SmallDoc

- Name: InsertTTLColl-Large
  Type: CrudActor
  Database: *db
  Threads: 300
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        Duration: *phaseDuration
        Collection: Collection0
        Operations:
        - OperationName: insertOne
          OperationCommand:
            Document: *LargeDoc

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone
      - standalone-all-feature-flags
      - replica
      - replica-all-feature-flags
    branch_name:
      $neq:
      - v4.2
      - v4.4
      - v5.0
