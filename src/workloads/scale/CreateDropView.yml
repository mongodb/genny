SchemaVersion: 2018-07-01
Owner: "@mongodb/product-perf"
Description: |
  This workload loads a collection with documents and then repeatedly 
  create and drops a view on that collection.
# This workload does not support sharding yet.
Keywords:
- scale
- view
- create
- drop

# These two values should match those are the top of MixPhases.yml
dbname: &dbname viewDB
DocumentCount: &NumDocs 100000
CollectionCount: &NumColls 1


Clients:
  Default:
    QueryOptions:
      maxPoolSize: 500
  Insert:
    QueryOptions:
      maxPoolSize: 500
  Query:
    QueryOptions:
      maxPoolSize: 500
  Remove:
    QueryOptions:
      maxPoolSize: 500
  Update:
    QueryOptions:
      maxPoolSize: 500


Actors:
- Name: Setup
  Type: Loader
  Threads: 1
  Phases:
  - Repeat: 1
    BatchSize: 100
    Threads: 1
    DocumentCount: *NumDocs
    Database: *dbname
    CollectionCount: *NumColls
    Document: &doc
      id: {^RandomInt: {min: 0, max: *NumDocs}}
      a: {^RandomInt: {min: 0, max: *NumDocs}}
      # Note that in the original workload the string c was perfectly compressable. We can put a
      # constant there if needed.
      c: &string {^RandomString: {length: 50}}  # Adjust this so the doc comes out as 100 B.
    Indexes:
    - keys: {id: 1}
    - keys: {a: 1}
  - Phase: 1..3
    Nop: true

- Name: QuiesceBetweenLevels
  Type: RunCommand
  Threads: 1
  Phases:
  - &nop {Nop: true}
  - &quiesce
    Repeat: 1
    Database: admin
    Operations:
    # Fsync to force a checkpoint and quiesce the system.
    - OperationMetricsName: FsyncCommand
      OperationName: AdminCommand
      OperationCommand:
        fsync: 1
  - *nop
  - *quiesce

#This actor will speed up the FTDC sampling rate rate from the default of 1000 ms to 100 ms for the second phase that each CRUD actor is active. 
- Name: ViewCreateDrop
  Type: RunCommand
  Threads: 1
  Phases:
  - Nop: true
  - Nop: true 
  - &toggleView1
    Repeat: 100000
    Database: *dbname
    Operations:
    - OperationMetricsName: CreateViewMetric
      OperationIsQuiet: true
      OperationName: RunCommand
      OperationCommand:
        {create: myView, viewOn: Collection0, pipeline: [ { $match: { id: { $lt: 10 } } } ]}
    - OperationName: RunCommand
      OperationMetricsName: DropViewMetric
      OperationIsQuiet: true
      OperationCommand:
        drop: myView
  - Nop: true        

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - atlas
      - replica
      - replica-1dayhistory-15gbwtcache
      - replica-all-feature-flags
      - replica-maintenance-events
      - replica-noflowcontrol
      - single-replica
      - single-replica-classic-query-engine
      - single-replica-sbe
      - standalone