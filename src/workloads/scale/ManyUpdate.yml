SchemaVersion: 2018-07-01
Owner: "@mongodb/server-replication"
Description: |
  This workload loads a large number of small documents into a single collection, and then does a
  small multi-update which touches all of them.  It is intended to measure the impact of the load of
  replication of many oplog entries on the primary.  Number of documents should be significantly
  greater than the maximum replication batch size of 5K (50K is a good minimum).

Clients:
  Default:
    QueryOptions:
      maxPoolSize: 1000

Actors:
- Name: Setup
  Type: RunCommand
  Threads: 1
  Phases:
  - Repeat: 1
    Database: &DB test
    Operations:
    - OperationName: RunCommand
      OperationCommand: {dropDatabase: 1}
  - &Nop {Nop: true}
  - *Nop

- Name: Loader
  Type: Loader
  Threads: 10
  Phases:
  - *Nop
  - Repeat: 1
    Database: *DB
    CollectionCount: 1
    Threads: 10
    DocumentCount: 5e4
    BatchSize: 1000
    Document:  # Documents are approximately 100B in size
      i: 0
      string0: {^FastRandomString: {length: 100}}
  - *Nop

- Name: DocumentUpdater
  Type: CrudActor
  Threads: 1
  Database: *DB
  Phases:
  - *Nop
  - *Nop
  - Duration: 1 minutes
    MetricsName: Update
    Collection: Collection0
    Operations:
    - OperationName: updateMany
      OperationCommand:
        Filter: {}
        Update: {$inc: {i: 1}}
        Options:
          WriteConcern:
            Level: 1

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - atlas
      - replica
      - replica-noflowcontrol
      - replica-1dayhistory-15gbwtcache
      - replica-all-feature-flags
      - single-replica
      - standalone
