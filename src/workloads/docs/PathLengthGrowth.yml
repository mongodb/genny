SchemaVersion: 2018-07-01
Owner: "@mongodb/sys-perf"
Description: |
  This workload is meant to track path length growth and processor efficiency

dbname: &dbname 10kDocs
DocumentCount: &NumDocs 10000
CollectionCount: &NumColls 1

NumPhases: &NumPhases 3

Document: &doc
  a: {^RandomInt: {min: 0, max: *NumDocs}}
  b: {^RandomString: {length: 16}}

Clients:
  Default:
    QueryOptions:
      maxPoolSize: 1000

ActorTemplates:
- TemplateName: ReadsActorTemplate
  Config:
    Name: {^Parameter: {Name: "Name", Default: ReadsActor}}
    Type: CrudActor
    Database: *dbname
    Threads: {^Parameter: {Name: "Threads", Default: 1}}
    Phases:
      OnlyActiveInPhases:
        Active: {^Parameter: {Name: "ActivePhases", Default: [2]}}
        NopInPhasesUpTo: *NumPhases
        PhaseConfig:
          Repeat: 10000
          RecordFailure: true
          CollectionCount: *NumColls
          Operations:
          - OperationName: find
            OperationCommand:
              Filter: { a: { ^RandomInt: { min: 0, max: *NumDocs } } }
            OperationMetricsName: ReadDocs
            ThrowOnFailure: false

Actors:
- Name: Setup
  Type: Loader
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        # Insert 10k documents to our singular collection
        Repeat: 1
        BatchSize: 100
        Threads: 1
        DocumentCount: *NumDocs
        Database: *dbname
        CollectionCount: *NumColls
        Document: *doc
        Indexes:
        - keys: {a: 1}

# - Name: QuiescePhase
#   Type: QuiesceActor
#   Threads: 1
#   Database: *dbname
#   Phases:
#     OnlyActiveInPhases:
#       Active: [1]
#       NopInPhasesUpTo: *NumPhases
#       PhaseConfig:
#         Repeat: 1

- ActorFromTemplate:
    TemplateName: ReadsActorTemplate
    TemplateParameters:
      Name: {^Parameter: {Name: "QueryName", Default: QueryActor}}
      Threads: {^Parameter: {Name: "QueryThreads", Default: 1}}
      ActivePhases: [2]


AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone