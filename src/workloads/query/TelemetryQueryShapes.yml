SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  This workload tests performance of telemetry with different query shapes.

KeyWords:
- telemetry
- query
- shape

GlobalDefaults:
  Database: &Database test
  Collection: &Collection Collection0
  DocumentCount: &DocumentCount 1e6
  Repeat: &Repeat 10
  Threads: &Threads 1
  MaxPhases: &MaxPhases 3
  nop: &Nop {Nop: true}
  dbname: &db test

Actors:
# Clear any pre-existing collection state.
- Name: ClearCollection
  Type: CrudActor
  Database: *Database
  Threads: *Threads
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Threads: *Threads
        Collection: *Collection
        Operations:
        - OperationName: drop

- Name: InsertData
  Type: Loader
  Threads: 4
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        MultipleThreadsPerCollection: true
        CollectionCount: 1
        DocumentCount: *DocumentCount
        BatchSize: 1000
        Document:
          a: &integer {^RandomInt: {min: -100, max: 100}}
          b: *integer
          string: &string {^RandomString: {length: 5}}

- Name: Quiesce
  Type: QuiesceActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [2]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1

- Name: SimpleFind
  Type: CrudActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Collection: *Collection
        Operations:
        - OperationName: find
          OperationCommand:
            Filter: {a: 1}

- Name: SimpleFindMultiple
  Type: CrudActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Collection: *Collection
        Operations:
        - OperationName: find
          OperationCommand:
            Filter: {a: 1, b: 2}

- Name: SimpleFindGt
  Type: CrudActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Collection: *Collection
        Operations:
        - OperationName: find
          OperationCommand:
            Filter: {b: {$gt: 4}}

- Name: SimpleFindInSingleArr
  Type: CrudActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Collection: *Collection
        Operations:
        - OperationName: find
          OperationCommand:
            Filter: {a: {$in: [2]}}

- Name: SimpleFindInArray
  Type: CrudActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Collection: *Collection
        Operations:
        - OperationName: find
          OperationCommand:
            Filter: {string: {$in: ["hello", "hi", "bye"]}}

- Name: SimpleFindBool
  Type: CrudActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Collection: *Collection
        Operations:
        - OperationName: find
          OperationCommand:
            Filter: {a: false}

- Name: SimpleFindExists
  Type: CrudActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Collection: *Collection
        Operations:
        - OperationName: find
          OperationCommand:
            Filter: {a: {$exists: true}}

- Name: SimpleFindNotExists
  Type: CrudActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Collection: *Collection
        Operations:
        - OperationName: find
          OperationCommand:
            Filter: {a: {$not: {$exists: true}}}

- Name: SimpleFindLtGt
  Type: CrudActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Collection: *Collection
        Operations:
        - OperationName: find
          OperationCommand:
            Filter: {b: {$lt: 6}, a: {$gt: 4}}

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - replica
      - replica-all-feature-flags
    branch_name:
      $neq:
      - v4.0
      - v4.2
      - v4.4
      - v5.0
