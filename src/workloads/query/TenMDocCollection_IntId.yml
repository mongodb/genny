SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: >
  This workload tests performance of IDHACK on queries with int _id.

KeyWords:
- IDHACK

GlobalDefaults:
  Database: &Database test
  Collection: &Collection Collection0
  MaxPhases: &MaxPhases 10

Clients:
  Default:
    QueryOptions:
      connectTimeoutMS: 3_600_000  # 1 hour
      maxPoolSize: 2000
      socketTimeoutMS: 3_600_000  # 1 hour

ActorTemplates:
- TemplateName: IDHACK
  Config:
    LoadConfig:
      Path: TenMDocCollection_Base.tmpl
      Key: ActorTemplateConfig
      Parameters:
        MaxPhases: *MaxPhases
        Operations:
        - OperationName: find
          OperationCommand:
            Filter: {_id: {^RandomInt: {min: 0, max: 9999999}}}
- TemplateName: IDFieldPointProject
  Config:
    LoadConfig:
      Path: TenMDocCollection_Base.tmpl
      Key: ActorTemplateConfig
      Parameters:
        MaxPhases: *MaxPhases
        Operations:
        - OperationName: find
          OperationCommand:
            Filter: {_id: {^RandomInt: {min: 0, max: 9999999}}}
            Options:
              Projection: {_id: 1}
- TemplateName: IDFieldEq
  Config:
    LoadConfig:
      Path: TenMDocCollection_Base.tmpl
      Key: ActorTemplateConfig
      Parameters:
        MaxPhases: *MaxPhases
        Operations:
        - OperationName: find
          OperationCommand:
            Filter: {a: {$eq: {^RandomInt: {min: 10000000, max: 19999999}}}}
- TemplateName: IDFieldIn
  Config:
    LoadConfig:
      Path: TenMDocCollection_Base.tmpl
      Key: ActorTemplateConfig
      Parameters:
        MaxPhases: *MaxPhases
        Operations:
        - OperationName: find
          OperationCommand:
            Filter: {a: {$in: {^Array: {
              distinct: true,
              number: {^Parameter: {Name: "Number", Default: 100000}},
              of: {^RandomInt: {min: 10000000, max: 19999999}}}}}}
- TemplateName: IDFieldOr
  Config:
    LoadConfig:
      Path: TenMDocCollection_Base.tmpl
      Key: ActorTemplateConfig
      Parameters:
        MaxPhases: *MaxPhases
        Operations:
        - OperationName: find
          OperationCommand:
            Filter:
              $or:
                ^Array:
                  distinct: true
                  number: 10
                  of:
                    $and:
                    - b: {$gte: {^RandomInt: {min: 20000000, max: 29999999}}}
                    - b: {$lt: {^RandomInt: {min: 20000000, max: 29999999}}}

Actors:
- LoadConfig:
    Path: TenMDocCollection_Base.tmpl
    Key: ClearCollectionActor
    Parameters:
      MaxPhases: *MaxPhases
- LoadConfig:
    Path: TenMDocCollection_Base.tmpl
    Key: PrepopulateActor
    Parameters:
      Document:
        # The multiplier is multiplied by the ActorID, and added to the value.
        # Since this is the second actor, the ActorIDs increment for each thread starting at 2.
        # e.g -2000000 + 2 * 1000000 = 0, -1999999 + 2 * 1000000 = 1, etc.
        # Once complete, the ids in the collection will be the range 0-9999999.
        _id: {^Inc: {start: -2000000, multiplier: 1000000}}
        # [10M, 20M)
        a: {^Inc: {start: -1000000, multiplier: 1000000}}
        # [20M, 30M)
        b: {^Inc: {start: 0, multiplier: 1000000}}
      Indexes:
        - keys: {a: 1}
        - keys: {b: 1}
        - keys: {a: -1, b: -1}
      MaxPhases: *MaxPhases
- LoadConfig:
    Path: TenMDocCollection_Base.tmpl
    Key: QuiesceActor
    Parameters:
      MaxPhases: *MaxPhases
- ActorFromTemplate:
    TemplateName: IDHACK
    TemplateParameters:
      Name: IDHACK032Threads
      OnlyActiveInPhase: 3
      Threads: 32
- ActorFromTemplate:
    TemplateName: IDHACK
    TemplateParameters:
      Name: IDHACK128Threads
      OnlyActiveInPhase: 4
      Threads: 128
- ActorFromTemplate:
    TemplateName: IDHACK
    TemplateParameters:
      Name: IDHACK256Threads
      OnlyActiveInPhase: 5
      Threads: 256
- ActorFromTemplate:
    TemplateName: IDFieldPointProject
    TemplateParameters:
      Name: IDFieldPointProject128Threads
      OnlyActiveInPhase: 6
      Threads: 128
- ActorFromTemplate:
    TemplateName: IDFieldEq
    TemplateParameters:
      Name: IDFieldEq128Threads
      OnlyActiveInPhase: 7
      Threads: 128
- ActorFromTemplate:
    TemplateName: IDFieldIn
    TemplateParameters:
      Name: IDField10KIn128Threads
      Number: 10000
      OnlyActiveInPhase: 8
      Threads: 128
- ActorFromTemplate:
    TemplateName: IDFieldIn
    TemplateParameters:
      Name: IDField100KIn128Threads
      OnlyActiveInPhase: 9
      Threads: 128
- ActorFromTemplate:
    TemplateName: IDFieldOr
    TemplateParameters:
      Name: IDFieldOr128Threads
      OnlyActiveInPhase: 10
      Threads: 128

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone-all-feature-flags
      - standalone-query-stats
      - standalone
      - standalone-query-stats-small-rate-limit
      - shard
      - shard-query-stats
      - shard-limited-query-stats
      - shard-lite
      - shard-lite-query-stats
      - shard-lite-limited-query-stats
      - single-replica
      - single-replica-query-stats
      - replica
      - replica-query-stats
      - atlas-like-replica.2022-10
      - atlas-like-replica-query-stats.2022-10
