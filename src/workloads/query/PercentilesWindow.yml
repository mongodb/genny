SchemaVersion: 2018-07-01
Owner: "@mongodb/query-execution"
Description: |
  Run tests for $percentile setWindowFields over various window sizes.
Keywords:
- setWindowFields
- percentile

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone-all-feature-flags
    branch_name:
      $neq:
      - v4.0
      - v4.2
      - v4.4
      - v5.0
      - v6.0

GlobalDefaults:
  MaxPhases: &maxPhases 10
  Database: &db percentiles

  # The Loader actor creates collections named "Collection<N>" where N corresponds to the thread's
  # number. We'll use a single collection, created by a single thread, so it becomes 'Collection0'.
  Collection: &coll Collection0
  DocumentCount: &docCount 100000
  Dist: &dist {^RandomDouble: {distribution: normal, mean: 50.0, sigma: 10.0}}

ActorTemplates:
- TemplateName: CreateDataset
  Config:
    Name: "CreateDataset"
    Type: Loader
    Threads: 1
    Phases:
      OnlyActiveInPhases:
        Active: [{^Parameter: {Name: "OnlyActiveInPhase", Default: 1024}}]
        NopInPhasesUpTo: *maxPhases
        PhaseConfig:
          Threads: 1
          Repeat: 1
          Database: *db
          CollectionCount: 1
          DocumentCount: *docCount
          BatchSize: 1000
          Document:
            _id: {^Inc: {start: 0}}
            data: {^Parameter: {Name: "Data", Default: 0}}
            partitionKey: {^RandomInt: {min: 1, max: 5}}
- TemplateName: ComputePercentile
  Config:
    Name: {^Parameter: {Name: "Name", Default: "ComputePercentile"}}
    Type: CrudActor
    Threads: 1
    Phases:
      OnlyActiveInPhases:
        Active: [{^Parameter: {Name: "OnlyActiveInPhase", Default: 1024}}]
        NopInPhasesUpTo: *maxPhases
        PhaseConfig:
          Repeat: 100
          Database: *db
          Collection: *coll
          Operations:
          - OperationName: aggregate
            OperationCommand:
              Pipeline: [{$setWindowFields: { sortBy: { _id: 1 }, output: { p: { $percentile: { p: [0.9], input: "$data", algorithm: "approximate" }, window: { documents: {^Parameter: {Name: "D", Default: [-10, 10]}} } }}}}]
              allowDiskUse: true

- TemplateName: ComputeMin
  Config:
    Name: {^Parameter: {Name: "Name", Default: "ComputePercentile"}}
    Type: CrudActor
    Threads: 1
    Phases:
      OnlyActiveInPhases:
        Active: [{^Parameter: {Name: "OnlyActiveInPhase", Default: 1024}}]
        NopInPhasesUpTo: *maxPhases
        PhaseConfig:
          Repeat: 100
          Database: *db
          Collection: *coll
          Operations:
          - OperationName: aggregate
            OperationCommand:
              Pipeline: [{$setWindowFields: {sortBy: { _id: 1 }, output: { p: { $min: "$data", window: { documents:  {^Parameter: {Name: "D", Default: [-10, 10]}} } }}}}]
              allowDiskUse: true

Actors:
- ActorFromTemplate:
    TemplateName: CreateDataset
    TemplateParameters:
      OnlyActiveInPhase: 0
      Data: *dist

- ActorFromTemplate:
    TemplateName: ComputePercentile
    TemplateParameters:
      Name: "percentile_bounded"
      OnlyActiveInPhase: 2

- ActorFromTemplate:
    TemplateName: ComputePercentile
    TemplateParameters:
      Name: "percentile_cumulative"
      D: [0, "unbounded"]
      OnlyActiveInPhase: 3

- ActorFromTemplate:
    TemplateName: ComputeMin
    TemplateParameters:
      Name: "min_bounded"
      OnlyActiveInPhase: 4

- ActorFromTemplate:
    TemplateName: ComputeMin
    TemplateParameters:
      Name: "min_cumulative"
      D: [0, "unbounded"]
      OnlyActiveInPhase: 5
