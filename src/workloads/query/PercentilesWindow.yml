SchemaVersion: 2018-07-01
Owner: "@mongodb/query-execution"
Description: |
  Run tests for $percentile window functions over various bounded window sizes with two different percentile values. 
  Bounded window functions use a different implementation than the $percentile accumulator by using an accurate algorithm. 
  This workload is to compare the speed of this implementation over different window sizes and percentiles to $min.

Keywords:
- setWindowFields
- percentile

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone-all-feature-flags
    branch_name:
      $neq:
      - v4.0
      - v4.2
      - v4.4
      - v5.0
      - v6.0

GlobalDefaults:
  MaxPhases: &maxPhases 14
  Database: &db percentiles
  Collection: &coll Collection0
  DocumentCount: &docCount 100000

ActorTemplates:
- TemplateName: CreateDataset
  Config:
    Name: "CreateDataset"
    Type: Loader
    Threads: 1
    Phases:
      OnlyActiveInPhases:
        Active: [{^Parameter: {Name: "OnlyActiveInPhase", Default: 1024}}]
        NopInPhasesUpTo: *maxPhases
        PhaseConfig:
          Threads: 1
          Repeat: 1
          Database: *db
          CollectionCount: 1
          DocumentCount: *docCount
          BatchSize: 1000
          Document:
            _id: {^Inc: {start: 0}}
            data: {^Parameter: {Name: "Data", Default: 0}}

- TemplateName: ComputePercentile
  Config:
    Name: {^Parameter: {Name: "Name", Default: "ComputePercentile"}}
    Type: CrudActor
    Threads: 1
    Phases:
      OnlyActiveInPhases:
        Active: [{^Parameter: {Name: "OnlyActiveInPhase", Default: 1024}}]
        NopInPhasesUpTo: *maxPhases
        PhaseConfig:
          Repeat: 10
          Database: *db
          Collection: *coll
          Operations:
          - OperationName: aggregate
            OperationCommand:
              Pipeline: [{$setWindowFields: { sortBy: { _id: 1 }, output: { p: { $percentile: { p: {^Parameter: {Name: "P", Default: [0.99]}}, input: "$data", algorithm: "approximate" }, window: { documents: {^Parameter: {Name: "D", Default: [-10, 10]}} } }}}}]
              allowDiskUse: true

- TemplateName: ComputeMin
  Config:
    Name: {^Parameter: {Name: "Name", Default: "ComputePercentile"}}
    Type: CrudActor
    Threads: 1
    Phases:
      OnlyActiveInPhases:
        Active: [{^Parameter: {Name: "OnlyActiveInPhase", Default: 1024}}]
        NopInPhasesUpTo: *maxPhases
        PhaseConfig:
          Repeat: 10
          Database: *db
          Collection: *coll
          Operations:
          - OperationName: aggregate
            OperationCommand:
              Pipeline: [{$setWindowFields: {sortBy: { _id: 1 }, output: { p: { $min: "$data", window: { documents: {^Parameter: {Name: "D", Default: [-10, 10]}} } }}}}]
              allowDiskUse: true

Actors:
- ActorFromTemplate:
    TemplateName: CreateDataset
    TemplateParameters:
      OnlyActiveInPhase: 0
      Data: {^RandomDouble: {distribution: normal, mean: 50.0, sigma: 10.0}}

- ActorFromTemplate:
    TemplateName: ComputePercentile
    TemplateParameters:
      Name: "percentile_bounded"
      OnlyActiveInPhase: 1

- ActorFromTemplate:
    TemplateName: ComputePercentile
    TemplateParameters:
      Name: "percentile_bounded_middle_p"
      P: [0.6]
      OnlyActiveInPhase: 2

- ActorFromTemplate:
    TemplateName: ComputePercentile
    TemplateParameters:
      Name: "percentile_bounded_low_p"
      P: [0.05]
      OnlyActiveInPhase: 3

- ActorFromTemplate:
    TemplateName: ComputePercentile
    TemplateParameters:
      Name: "percentile_bounded_multiple_p"
      P: [0.05, 0.2, 0.99]
      OnlyActiveInPhase: 4

- ActorFromTemplate:
    TemplateName: ComputePercentile
    TemplateParameters:
      Name: "percentile_large_window"
      D: [0, "unbounded"]
      OnlyActiveInPhase: 5

- ActorFromTemplate:
    TemplateName: ComputePercentile
    TemplateParameters:
      Name: "percentile_large_window_middle_p"
      D: [0, "unbounded"]
      P: [0.6]
      OnlyActiveInPhase: 6

- ActorFromTemplate:
    TemplateName: ComputePercentile
    TemplateParameters:
      Name: "percentile_large_window_low_p"
      D: [0, "unbounded"]
      P: [0.05]
      OnlyActiveInPhase: 4

- ActorFromTemplate:
    TemplateName: ComputePercentile
    TemplateParameters:
      Name: "percentile_large_window_multiple_p"
      D: [0, "unbounded"]
      P: [0.05, 0.2, 0.99]
      OnlyActiveInPhase: 7

- ActorFromTemplate:
    TemplateName: ComputePercentile
    TemplateParameters:
      Name: "percentile_use_t-digest"
      D: ["unbounded", "current"]
      OnlyActiveInPhase: 8

- ActorFromTemplate:
    TemplateName: ComputePercentile
    TemplateParameters:
      Name: "percentile_use_t-digest_middle_p"
      D: ["unbounded", "current"]
      P: [0.6]
      OnlyActiveInPhase: 9

- ActorFromTemplate:
    TemplateName: ComputeMin
    TemplateParameters:
      Name: "min_bounded"
      OnlyActiveInPhase: 10

- ActorFromTemplate:
    TemplateName: ComputeMin
    TemplateParameters:
      Name: "min_large_window"
      D: [0, "unbounded"]
      OnlyActiveInPhase: 11

- ActorFromTemplate:
    TemplateName: ComputeMin
    TemplateParameters:
      Name: "min_cumulative"
      D: ["unbounded", "current"]
      OnlyActiveInPhase: 12
