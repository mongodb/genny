SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: >
  This is a template of helpers for the QueryStats workload.

GlobalDefaults:
  PhasesPerStage: &PhasesPerStage 4
  SetupPhases: &SetupPhases 2
  Database: &Database {^Parameter: {Name: Database, Default: {unused: "Please specify a database."}}}
  Collection: &Collection {^Parameter: {Name: Collection, Default: {unused: "Please specify the collection."}}}
  Stage: &Stage {^Parameter: {Name: Stage, Default: {unused: "Please specify the stage."}}}
  StageToPhase: &StageToPhase {^NumExpr: {withExpression: "(stage - 1) * pps + setup", andValues: {stage: *Stage, pps: *PhasesPerStage, setup: *SetupPhases}}}
  NumStages: &NumStages {^Parameter: {Name: NumStages, Default: {unused: "Please specify the number of stages."}}}
  MaxPhases: &MaxPhases {^NumExpr: {withExpression: "stages * pps + setup", andValues: {stages: *NumStages, pps: *PhasesPerStage, setup: *SetupPhases}}}
  BinDataSensitive: &BinDataSensitive {^BinDataSensitive: {numBytes: 32}}
  QueryStatsCacheSize: &QueryStatsCacheSize {^Parameter: {Name: QueryStatsCacheSize, Default: {unused: "Need to specify a query stats cache size."}}}
  QueryStatsSuffix: &QueryStatsSuffix {^Parameter: {Name: Suffix, Default: ""}}

SetupStage:
- Name: ClearCollection
  Type: CrudActor
  Database: *Database
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Threads: 1
        Collection: *Collection
        Operations:
        - OperationName: drop

- Name: InsertData
  Type: Loader
  Threads: 4
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        MultipleThreadsPerCollection: true
        CollectionCount: 1
        DocumentCount: {^Parameter: {Name: DocumentCount, Default: {unused: "Need to pass in a document count."}}}
        BatchSize: 1000
        Document:
          a1: &integer {^RandomInt: {min: -100, max: 100}}
          a2: *integer
          string: &string {^RandomString: {length: 5}}
        Indexes:
          - keys: {a1: 1, a2: 1}

QueryStatsStage:
- Name: {^PreprocessorFormatString: {format: "ClearQueryStats%s", withArgs: [*QueryStatsSuffix]}}
  Type: RunCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [*StageToPhase]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: admin
        Operations:
        - OperationName: AdminCommand
          OperationCommand:
            # Configuring the queryStats store size to an arbitrary value which seems reasonable.
            # This ensures that if run on different sized machines, the test will remain the same.
            setParameter: 1
            internalQueryStatsCacheSize: 0MB

- Name: {^PreprocessorFormatString: {format: "SetQueryStats%s", withArgs: [*QueryStatsSuffix]}}
  Type: RunCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [{^NumExpr: {withExpression: "phase + 1", andValues: {phase: *StageToPhase}}}]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: admin
        Operations:
        - OperationName: AdminCommand
          OperationCommand:
            # Configuring the queryStats store size to an arbitrary value which seems reasonable.
            # This ensures that if run on different sized machines, the test will remain the same.
            setParameter: 1
            internalQueryStatsCacheSize: *QueryStatsCacheSize

- Name: {^PreprocessorFormatString: {format: "Quiesce%s", withArgs: [*QueryStatsSuffix]}}
  Type: QuiesceActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [{^NumExpr: {withExpression: "phase + 2", andValues: {phase: *StageToPhase}}}]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1

- Name: {^PreprocessorFormatString: {format: "FindCommand%s", withArgs: [*QueryStatsSuffix]}}
  Type: CrudActor
  Threads: 32
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [{^NumExpr: {withExpression: "phase + 3", andValues: {phase: *StageToPhase}}}]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Duration: 1 minute
        Collection: *Collection
        Operations:
        - OperationName: find
          OperationCommand:
            # This will create a find command with a random number of fields from 3 to 350, to create varying query shapes and sizes.
            Filter:
              {$and:
                [{a1: 1}, {a2: 1}, {^Object: {
                  withNEntries: {^RandomInt: {min: 1, max: 350}},
                  havingKeys: {^RandomString: {length: 10}},
                  andValues: {$exists: false},
                  duplicatedKeys: skip
                }}]
              }
- Name: {^PreprocessorFormatString: {format: "QueryStatsAggregation%s", withArgs: [*QueryStatsSuffix]}}
  Type: AdminCommand
  Threads: 32
  Phases:
    OnlyActiveInPhases:
      Active: {^Parameter: {Name: QueryStatsActive, Default: [{^NumExpr: {withExpression: "phase + 3", andValues: {phase: *StageToPhase}}}]}}
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Duration: 1 minute
        SleepBefore: 5 seconds
        Database: admin
        Operations:
        - OperationMetricsName: QueryStatsMetrics
          OperationName: AdminCommand
          OperationCommand:
            aggregate: 1
            pipeline:
            - $queryStats: {^Parameter: {Name: "QueryStatsParameters", Default: {}}}
              # The purpose of $count is to ensure we've exhausted the cursor/ data stream and looked at each partition.
            - $count: "numDocuments"
            cursor: {}

QueryStatsTriple:
  ^FlattenOnce:
    # Find without QueryStats.
    - LoadConfig:
        Path: QueryStatsHelpers.yml
        Key: QueryStatsStage
        Parameters:
          Database: *Database
          Collection: *Collection
          NumStages: *NumStages
          Stage: {^NumExpr: {withExpression: "3 * (group - 1) + 1", andValues: {group: &Group {^Parameter: {Name: Group, Default: 1}}}}}
          Suffix: {^PreprocessorFormatString: {format: "Base%s", withArgs: [*QueryStatsCacheSize]}}
          QueryStatsActive: []
          QueryStatsParameters: {}

    # QueryStats with HMAC.
    - LoadConfig:
        Path: QueryStatsHelpers.yml
        Key: QueryStatsStage
        Parameters:
          Database: *Database
          Collection: *Collection
          NumStages: *NumStages
          Stage: {^NumExpr: {withExpression: "3 * (group - 1) + 2", andValues: {group: *Group}}}
          Suffix: {^PreprocessorFormatString: {format: "WithHMAC%s", withArgs: [*QueryStatsCacheSize]}}
          QueryStatsParameters: {transformIdentifiers: {algorithm: "hmac-sha-256", hmacKey: *BinDataSensitive}}

    # QueryStats without HMAC.
    - LoadConfig:
        Path: QueryStatsHelpers.yml
        Key: QueryStatsStage
        Parameters:
          Database: *Database
          Collection: *Collection
          NumStages: *NumStages
          Stage: {^NumExpr: {withExpression: "3 * (group - 1) + 3", andValues: {group: *Group}}}
          Suffix: {^PreprocessorFormatString: {format: "WithoutHMAC%s", withArgs: [*QueryStatsCacheSize]}}
          QueryStatsParameters: {}
