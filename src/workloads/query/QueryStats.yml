SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: >
  This workload tests performance of $queryStats with and without applying HMAC.

KeyWords:
- queryStats
- redaction

Clients:
  Default:
    QueryOptions:
      connectTimeoutMS: 3_600_000  # 1 hour
      maxPoolSize: 2000
      socketTimeoutMS: 3_600_000  # 1 hour

GlobalDefaults:
  Database: &Database test
  Collection: &Collection Collection0
  DocumentCount: &DocumentCount 1e6
  NumStages: &NumStages 12

Actors: 
  ^FlattenOnce:
  - LoadConfig:
      Path: QueryStats.tmpl
      Key: SetupStage
      Parameters:
        Database: *Database
        Collection: *Collection
        DocumentCount: *DocumentCount
        NumStages: *NumStages
  - LoadConfig:
      Path: QueryStats.tmpl
      Key: QueryStatsTriple
      Parameters:
        Database: *Database
        Collection: *Collection
        NumStages: *NumStages
        Group: 1
        QueryStatsCacheSize: 25MB
  - LoadConfig:
      Path: QueryStats.tmpl
      Key: QueryStatsTriple
      Parameters:
        Database: *Database
        Collection: *Collection
        NumStages: *NumStages
        Group: 2
        QueryStatsCacheSize: 250MB
  - LoadConfig:
      Path: QueryStats.tmpl
      Key: QueryStatsTriple
      Parameters:
        Database: *Database
        Collection: *Collection
        NumStages: *NumStages
        Group: 3
        QueryStatsCacheSize: 500MB
  - LoadConfig:
      Path: QueryStats.tmpl
      Key: QueryStatsTriple
      Parameters:
        Database: *Database
        Collection: *Collection
        NumStages: *NumStages
        Group: 4
        QueryStatsCacheSize: 1GB

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone-all-feature-flags
      - standalone-query-stats
      - standalone-query-stats-small-rate-limit
      - single-replica-query-stats
      - replica-query-stats
      - atlas-like-replica-query-stats.2022-10
