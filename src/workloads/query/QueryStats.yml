SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: >
  This workload tests $queryStats performance.

KeyWords:
- queryStats
- redaction

Clients:
  Default:
    QueryOptions:
      connectTimeoutMS: 3_600_000  # 1 hour
      maxPoolSize: 4000
      socketTimeoutMS: 3_600_000  # 1 hour

GlobalDefaults:
  CacheSizeMb: &CacheSizeMb 300
  HmacParameters: &HmacParameters {transformIdentifiers: {algorithm: "hmac-sha-256", hmacKey: {^BinDataSensitive: {numBytes: 32}}}}
  MaxPhase: &MaxPhase 50
  RateLimitHz: &RateLimitHz 100

  FixedPayload: &FixedPayload
    ^Object:
      withNEntries: 175
      havingKeys: {^RandomString: {length: 10}}
      andValues: {$exists: false}
      duplicatedKeys: skip
  RandomPayload: &RandomPayload
    ^Object:
      withNEntries: {^RandomInt: {min: 1, max: 350}}
      havingKeys: {^RandomString: {length: 10}}
      andValues: {$exists: false}
      duplicatedKeys: skip

Actors:
- LoadConfig:
    Path: ../../phases/query/QueryStats.tmpl
    Key: ClearCollection  # Drops the collection, only needs to happen once.
    Parameters:
      MaxPhase: *MaxPhase
      Phase: 0
- LoadConfig:
    Path: ../../phases/query/QueryStats.tmpl
    Key: InsertData  # Repopulates the collection, only needs to happen once.
    Parameters:
      MaxPhase: *MaxPhase
      Phase: 1
- LoadConfig:
    Path: ../../phases/query/QueryStats.tmpl
    Key: CacheSizeActor  # Clear the query stats cache by setting it to 0MB.
    Parameters:
      CacheSizeMb: 0
      MaxPhase: *MaxPhase
      Phases: [10, 20, 30, 40]  # To make analysis easier, each variant (there are 4 here) gets its
                                # own block of 10 phases. This way, the FindCommand and QueryStats
                                # actors always end with the same digit. The extra no-op phases will
                                # simply be ignored.
- LoadConfig:
    Path: ../../phases/query/QueryStats.tmpl
    Key: CacheSizeActor  # Reset the query stats cache to the target size. We do this explicitly to
                         # prevent fluctuations in the query stats cache size based on machine type,
                         # since the default value is 1% of RAM.
    Parameters:
      CacheSizeMb: *CacheSizeMb
      MaxPhase: *MaxPhase
      Phases: [11, 21, 31, 41]
- LoadConfig:
    Path: ../../phases/query/QueryStats.tmpl
    Key: RateLimitActor  # Disable the rate limit so that we can prepopulate the cache faster.
    Parameters:
      MaxPhase: *MaxPhase
      Phases: [12, 22, 32, 42]
      RateLimitHz: -1
- LoadConfig:
    Path: ../../phases/query/QueryStats.tmpl
    Key: QuiesceActor  # Wait for all threads to quiesce before running prepop or query stats.
    Parameters:
      MaxPhase: *MaxPhase
      Phases: [
        13, 23, 33, 43,
        16, 26, 36, 46,
      ]
- LoadConfig:
    Path: ../../phases/query/QueryStats.tmpl
    Key: PrepopulateActor  # Prepopulate the query stats cache until it's full. This is to simulate
                           # the steady-state scenario, which is what we're mostly interested in.
    Parameters:
      CacheSizeMb: *CacheSizeMb
      MaxPhase: *MaxPhase
      Phases: [14, 24, 34, 44]
- LoadConfig:
    Path: ../../phases/query/QueryStats.tmpl
    Key: RateLimitActor  # Reset the rate limit to the desired value. This needs to be kept
                         # up-to-date with the actual rate limit.
    Parameters:
      MaxPhase: *MaxPhase
      Phases: [15, 25, 35, 45]
      RateLimitHz: *RateLimitHz

# No concurrent $queryStats query, all find queries are roughly the same size.
- LoadConfig:
    Path: ../../phases/query/QueryStats.tmpl
    Key: FindCommandActor
    Parameters:
      CacheSizeMb: *CacheSizeMb
      MaxPhase: *MaxPhase
      Phase: 17
      Payload: *FixedPayload
      RateLimitHz: *RateLimitHz
      Suffix: "Base-Fixed"

# Concurrent HMAC-transformed $queryStats query, all find queries are roughly the same size.
- LoadConfig:
    Path: ../../phases/query/QueryStats.tmpl
    Key: FindCommandActor
    Parameters:
      CacheSizeMb: *CacheSizeMb
      MaxPhase: *MaxPhase
      Phase: 27
      Payload: *FixedPayload
      RateLimitHz: *RateLimitHz
      Suffix: "Hmac-Fixed"
- LoadConfig:
    Path: ../../phases/query/QueryStats.tmpl
    Key: QueryStatsActor
    Parameters:
      CacheSizeMb: *CacheSizeMb
      MaxPhase: *MaxPhase
      Phase: 27
      QueryStatsParameters: *HmacParameters
      RateLimitHz: *RateLimitHz
      Suffix: "Hmac-Fixed"

# No concurrent $queryStats query, find queries vary widely in size.
- LoadConfig:
    Path: ../../phases/query/QueryStats.tmpl
    Key: FindCommandActor
    Parameters:
      CacheSizeMb: *CacheSizeMb
      MaxPhase: *MaxPhase
      Phase: 37
      Payload: *RandomPayload
      RateLimitHz: *RateLimitHz
      Suffix: "Base-Random"

# Concurrent HMAC-transformed $queryStats query, find queries vary widely in size.
- LoadConfig:
    Path: ../../phases/query/QueryStats.tmpl
    Key: FindCommandActor
    Parameters:
      CacheSizeMb: *CacheSizeMb
      MaxPhase: *MaxPhase
      Phase: 47
      Payload: *RandomPayload
      RateLimitHz: *RateLimitHz
      Suffix: "Hmac-Random"
- LoadConfig:
    Path: ../../phases/query/QueryStats.tmpl
    Key: QueryStatsActor
    Parameters:
      CacheSizeMb: *CacheSizeMb
      MaxPhase: *MaxPhase
      Phase: 47
      QueryStatsParameters: *HmacParameters
      RateLimitHz: *RateLimitHz
      Suffix: "Hmac-Random"

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone-all-feature-flags
      - standalone-query-stats
      - standalone
      - standalone-query-stats-small-rate-limit
      - shard
      - shard-query-stats
      - shard-limited-query-stats
      - shard-lite
      - shard-lite-query-stats
      - shard-lite-limited-query-stats
      - single-replica
      - single-replica-query-stats
      - replica
      - replica-query-stats
      - atlas-like-replica.2022-10
      - atlas-like-replica-query-stats.2022-10
