SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: >
  This workload tests performance of $queryStats with and without applying HMAC.

KeyWords:
- queryStats
- redaction

Clients:
  Default:
    QueryOptions:
      connectTimeoutMS: 3_600_000  # 1 hour
      maxPoolSize: 4000
      socketTimeoutMS: 3_600_000  # 1 hour

GlobalDefaults:
  DocumentCount: &DocumentCount 1e6
  FixedEntriesPerObject: &FixedEntries 128
  LowVarianceEntriesPerObject: &LowVarianceEntries {^RandomInt: {min: 125, max: 250}}
  RandomEntriesPerObject: &RandomEntries {^RandomInt: {min: 1, max: 350}}
  NumGroups: &NumGroups 4

Actors: 
  ^FlattenOnce:
  - LoadConfig:
      Path: QueryStats.tmpl
      Key: SetupStage
      Parameters:
        DocumentCount: *DocumentCount
        NumGroups: *NumGroups
  - LoadConfig:
      Path: QueryStats.tmpl
      Key: QueryStatsGroup
      Parameters:
        NumGroups: *NumGroups
        Group: 1
        PrepopulateRatio: 1
        CycleLength: 25
        EntriesPerObject: *FixedEntries
        EntriesPerObjectName: "Cycle25Fixed"
  - LoadConfig:
      Path: QueryStats.tmpl
      Key: QueryStatsGroup
      Parameters:
        NumGroups: *NumGroups
        Group: 2
        PrepopulateRatio: 1
        CycleLength: 25
        EntriesPerObject: *RandomEntries
        EntriesPerObjectName: "Cycle25Random"
  - LoadConfig:
      Path: QueryStats.tmpl
      Key: QueryStatsGroup
      Parameters:
        NumGroups: *NumGroups
        Group: 3
        PrepopulateRatio: 1
        CycleLength: 5
        EntriesPerObject: *FixedEntries
        EntriesPerObjectName: "Cycle5Fixed"
  - LoadConfig:
      Path: QueryStats.tmpl
      Key: QueryStatsGroup
      Parameters:
        NumGroups: *NumGroups
        Group: 4
        PrepopulateRatio: 1
        CycleLength: 5
        EntriesPerObject: *RandomEntries
        EntriesPerObjectName: "Cycle5Random"
#  - LoadConfig:
#      Path: QueryStats.tmpl
#      Key: QueryStatsGroup
#      Parameters:
#        NumGroups: *NumGroups
#        Group: 1
#        PrepopulateRatio: 0
#        EntriesPerObject: *FixedEntries
#        EntriesPerObjectName: "128"
#  - LoadConfig:
#      Path: QueryStats.tmpl
#      Key: QueryStatsGroup
#      Parameters:
#        NumGroups: *NumGroups
#        Group: 2
#        PrepopulateRatio: 0
#        EntriesPerObject: *FixedEntries
#        EntriesPerObjectName: "128"
#  - LoadConfig:
#      Path: QueryStats.tmpl
#      Key: QueryStatsGroup
#      Parameters:
#        NumGroups: *NumGroups
#        Group: 3
#        PrepopulateRatio: 1
#        EntriesPerObject: *FixedEntries
#        EntriesPerObjectName: "128"
#  - LoadConfig:
#      Path: QueryStats.tmpl
#      Key: QueryStatsGroup
#      Parameters:
#        NumGroups: *NumGroups
#        Group: 4
#        PrepopulateRatio: 1
#        EntriesPerObject: *FixedEntries
#        EntriesPerObjectName: "128"
#
#  - LoadConfig:
#      Path: QueryStats.tmpl
#      Key: QueryStatsGroup
#      Parameters:
#        NumGroups: *NumGroups
#        Group: 5
#        PrepopulateRatio: 0
#        EntriesPerObject: *RandomEntries
#        EntriesPerObjectName: "Random"
#  - LoadConfig:
#      Path: QueryStats.tmpl
#      Key: QueryStatsGroup
#      Parameters:
#        NumGroups: *NumGroups
#        Group: 6
#        PrepopulateRatio: 0
#        EntriesPerObject: *RandomEntries
#        EntriesPerObjectName: "Random"
#  - LoadConfig:
#      Path: QueryStats.tmpl
#      Key: QueryStatsGroup
#      Parameters:
#        NumGroups: *NumGroups
#        Group: 7
#        PrepopulateRatio: 1
#        EntriesPerObject: *RandomEntries
#        EntriesPerObjectName: "Random"
#  - LoadConfig:
#      Path: QueryStats.tmpl
#      Key: QueryStatsGroup
#      Parameters:
#        NumGroups: *NumGroups
#        Group: 8
#        PrepopulateRatio: 1
#        EntriesPerObject: *RandomEntries
#        EntriesPerObjectName: "Random"
#
#  - LoadConfig:
#      Path: QueryStats.tmpl
#      Key: QueryStatsGroup
#      Parameters:
#        NumGroups: *NumGroups
#        Group: 9
#        PrepopulateRatio: 0
#        EntriesPerObject: *LowVarianceEntries
#        EntriesPerObjectName: "LowVariance"
#  - LoadConfig:
#      Path: QueryStats.tmpl
#      Key: QueryStatsGroup
#      Parameters:
#        NumGroups: *NumGroups
#        Group: 10
#        PrepopulateRatio: 0
#        EntriesPerObject: *LowVarianceEntries
#        EntriesPerObjectName: "LowVariance"
#  - LoadConfig:
#      Path: QueryStats.tmpl
#      Key: QueryStatsGroup
#      Parameters:
#        NumGroups: *NumGroups
#        Group: 11
#        PrepopulateRatio: 1
#        EntriesPerObject: *LowVarianceEntries
#        EntriesPerObjectName: "LowVariance"
#  - LoadConfig:
#      Path: QueryStats.tmpl
#      Key: QueryStatsGroup
#      Parameters:
#        NumGroups: *NumGroups
#        Group: 12
#        PrepopulateRatio: 1
#        EntriesPerObject: *LowVarianceEntries
#        EntriesPerObjectName: "LowVariance"

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone-all-feature-flags
      - standalone-query-stats
      - standalone-query-stats-small-rate-limit
      - single-replica-query-stats
      - replica-query-stats
      - atlas-like-replica-query-stats.2022-10
