SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: >
  This is the main workload for testing $queryStats performance regressions.

KeyWords:
- queryStats
- redaction

Clients:
  Default:
    QueryOptions:
      connectTimeoutMS: 3_600_000  # 1 hour
      maxPoolSize: 4000
      socketTimeoutMS: 3_600_000  # 1 hour

GlobalDefaults:
  # Workload "constants."
  ConstantNumGroups: &NumGroups 2  # Excluding the setup group.
  ConstantDatabase: &Database {LoadConfig: {Path: QueryStats.tmpl, Key: ConstantDatabase}}
  ConstantCollection: &Collection {LoadConfig: {Path: QueryStats.tmpl, Key: ConstantCollection}}
  ConstantStagesPerGroup: &StagesPerGroup 2

  # Entry count generators.
  ConstantFixedEntries: &FixedEntries {LoadConfig: {Path: QueryStats.tmpl, Key: ConstantFixedEntries}}
  ConstantRandomEntries: &RandomEntries {LoadConfig: {Path: QueryStats.tmpl, Key: ConstantRandomEntries}}

Actors:
  ^FlattenOnce:
  - LoadConfig:
      Path: QueryStats.tmpl
      Key: SetupGroup
      Parameters:
        NumGroups: *NumGroups
  - LoadConfig:
      Path: QueryStatsVariants.tmpl
      Key: UniqueBaseStage
      Parameters:
        Name: "Fixed"
        Database: *Database
        Collection: *Collection
        Group: 1
        NumGroups: *NumGroups
        StagesPerGroup: *StagesPerGroup
        StageInGroup: 1
        EntriesPerObject: *FixedEntries
  - LoadConfig:
      Path: QueryStatsVariants.tmpl
      Key: UniqueBaseStage
      Parameters:
        Name: "Random"
        Database: *Database
        Collection: *Collection
        Group: 1
        NumGroups: *NumGroups
        StagesPerGroup: *StagesPerGroup
        StageInGroup: 2
        EntriesPerObject: *RandomEntries
  - LoadConfig:
      Path: QueryStatsVariants.tmpl
      Key: UniqueHmacStage
      Parameters:
        Name: "Fixed"
        Database: *Database
        Collection: *Collection
        Group: 2
        NumGroups: *NumGroups
        StagesPerGroup: *StagesPerGroup
        StageInGroup: 1
        EntriesPerObject: *FixedEntries
  - LoadConfig:
      Path: QueryStatsVariants.tmpl
      Key: UniqueHmacStage
      Parameters:
        Name: "Random"
        Database: *Database
        Collection: *Collection
        Group: 2
        NumGroups: *NumGroups
        StagesPerGroup: *StagesPerGroup
        StageInGroup: 2
        EntriesPerObject: *RandomEntries

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone-all-feature-flags
      - standalone-query-stats
      - standalone-query-stats-small-rate-limit
      - single-replica-query-stats
      - replica-query-stats
      - atlas-like-replica-query-stats.2022-10
