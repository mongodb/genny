SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  This workload tests performance of $telemetry with and without redaction.

KeyWords:
- telemetry
- redaction

Clients:
  Default:
    QueryOptions:
      maxPoolSize: 400

GlobalDefaults:
  Database: &Database test
  Collection: &Collection Collection0
  DocumentCount: &DocumentCount 1e6
  Repeat: &Repeat 1000
  Threads: &Threads 32
  MaxPhases: &MaxPhases 6
  nop: &Nop {Nop: true}
  dbname: &db test
  binDataGen: &binDataGen {^BinData: {numBytes: 32}}

ActorTemplates:
- TemplateName: TelemetryAggregation
  Config:
    Name: {^Parameter: {Name: "Name", Default: "TelemetryAggregation"}}
    Type: AdminCommand
    Threads: 1
    Phases:
      OnlyActiveInPhases:
        Active: [{^Parameter: {Name: "OnlyActiveInPhase", Default: 1024}}]
        NopInPhasesUpTo: *MaxPhases
        PhaseConfig:
          Repeat: 1000
          Database: admin
          Operations:
          - OperationMetricsName: TelemetryWithRedactionMetrics
            OperationName: AdminCommand
            OperationCommand:
              aggregate: 1
              pipeline: [
                      {
                        $telemetry: {
                          redactIdentifiers: {^Parameter: {Name: "redactIdentifiers", Default: false}},
                          redactionKey: *binDataGen
                        }
                      }
                    ]
              cursor: {}

Actors:
- Name: ClearCollection
  Type: CrudActor
  Database: *Database
  Threads: *Threads
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Threads: *Threads
        Collection: *Collection
        Operations:
        - OperationName: drop

- Name: InsertData
  Type: Loader
  Threads: 4
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        MultipleThreadsPerCollection: true
        CollectionCount: 1
        DocumentCount: *DocumentCount
        BatchSize: 1000
        Document:
          a: &integer {^RandomInt: {min: -100, max: 100}}
          b: *integer
          string: &string {^RandomString: {length: 5}}
        Indexes:
          - keys: {a: 1, b: 1}
          - keys: {string: 1}

- Name: Quiesce
  Type: QuiesceActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [2]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1

# Run some commands so that telemetry is collected.
- Name: AggregationCommand
  Type: CrudActor
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [3]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1000
        Database: *Database
        Collection: *Collection
        Operations:
        - OperationMetricsName: PipelineWithoutOptions
          OperationName: aggregate
          OperationCommand:
            Pipeline: [{$match: {a: 42}}, {$group: {_id: "$b", sum: {$sum: "$a"}}}]

- Name: FindCommand
  Type: CrudActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [4]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1000
        Collection: *Collection
        Operations:
        - OperationName: find
          OperationCommand:
            Filter: {string: {$in: ["hello", "hi", "bye"]}}

# Telemetry with redaction.
- ActorFromTemplate:
    TemplateName: TelemetryAggregation
    TemplateParameters:
      Name: "TelemetryAggregationWithRedaction"
      redactIdentifiers: true
      OnlyActiveInPhase: 5

# Telemetry without redaction.
- ActorFromTemplate:
    TemplateName: TelemetryAggregation
    TemplateParameters:
      Name: "TelemetryAggregationWithoutRedaction"
      redactIdentifiers: false
      OnlyActiveInPhase: 6

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone-all-feature-flags
      - standalone-telemetry
