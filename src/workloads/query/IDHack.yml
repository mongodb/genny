SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  This workload tests performance of IDHACK.

KeyWords:
- IDHACK

Clients:
  Default:
    QueryOptions:
      maxPoolSize: 400

GlobalDefaults:
  Database: &Database test
  Collection: &Collection Collection0
  DocumentCount: &DocumentCount 1e6
  MaxPhases: &MaxPhases 23

ActorTemplates:
- TemplateName: IDHACK
  Config:
    Name: {^Parameter: {Name: "Name", Default: "IDHackQuery"}}
    Type: CrudActor
    Threads: {^Parameter: {Name: "Threads", Default: 1}}
    Phases:
      OnlyActiveInPhases:
        Active: [{^Parameter: {Name: "OnlyActiveInPhase", Default: {unused: "please specify in which phases this actor should be active."}}}]
        NopInPhasesUpTo: *MaxPhases
        PhaseConfig:
          Repeat: 1000
          Database: *Database
          Collection: *Collection
          Operations:
          - OperationName: find
            OperationCommand:
              Filter: {^Parameter: {Name: "Filter", Default: {_id: {^RandomInt: {min: 0, max: 4799}}}}}

Actors:
# Clear the collection before adding documents with a different type of _id.
- Name: ClearCollection
  Type: CrudActor
  Database: *Database
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [0, 6, 12, 18]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Threads: 1
        Collection: *Collection
        Operations:
        - OperationName: drop

- Name: LoadIntIDs
  Type: Loader
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        MultipleThreadsPerCollection: true
        CollectionCount: 1
        DocumentCount: 4800
        BatchSize: 1000
        Document:
          _id: {^Inc: {start: 0, step: 1}}

- Name: Quiesce
  Type: QuiesceActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [2, 8, 14, 20]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1

- ActorFromTemplate:
    TemplateName: IDHACK
    TemplateParameters:
      Name: IDHackOnIntID5Threads
      Threads: 5
      OnlyActiveInPhase: 3
      Filter: {_id: {^RandomInt: {min: 0, max: 4799}}}
- ActorFromTemplate:
    TemplateName: IDHACK
    TemplateParameters:
      Name: IDHackOnIntID15Threads
      Threads: 15
      OnlyActiveInPhase: 4
      Filter: {_id: {^RandomInt: {min: 0, max: 4799}}}

- ActorFromTemplate:
    TemplateName: IDHACK
    TemplateParameters:
      Name: IDHackOnIntID30Threads
      Threads: 30
      OnlyActiveInPhase: 5
      Filter: {_id: {^RandomInt: {min: 0, max: 4799}}}

- Name: LoadObjectIDs
  Type: Loader
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [7]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        MultipleThreadsPerCollection: true
        CollectionCount: 1
        DocumentCount: 4800
        BatchSize: 1000
        Document:
          _id: {^ObjectId: {^FormatString: {"format": "%04d%s", "withArgs": [{^Inc: {start: 0, step: 1}}, {^RandomString: {length: 20, alphabet: b}}]}}}

- ActorFromTemplate:
    TemplateName: IDHACK
    TemplateParameters:
      Name: IDHackOnOID5Threads
      Threads: 5
      OnlyActiveInPhase: 9
      Filter: {_id: {^ObjectId: {^FormatString: {"format": "%04d%s", "withArgs": [{^RandomInt: {min: 0, max: 4799}}, {^RandomString: {length: 20, alphabet: b}}]}}}}

- ActorFromTemplate:
    TemplateName: IDHACK
    TemplateParameters:
      Name: IDHackOnOID15Threads
      Threads: 15
      OnlyActiveInPhase: 10
      Filter: {_id: {^ObjectId: {^FormatString: {"format": "%04d%s", "withArgs": [{^RandomInt: {min: 0, max: 4799}}, {^RandomString: {length: 20, alphabet: b}}]}}}}

- ActorFromTemplate:
    TemplateName: IDHACK
    TemplateParameters:
      Name: IDHackOnOID30Threads
      Threads: 30
      OnlyActiveInPhase: 11
      Filter: {_id: {^ObjectId: {^FormatString: {"format": "%04d%s", "withArgs": [{^RandomInt: {min: 0, max: 4799}}, {^RandomString: {length: 20, alphabet: b}}]}}}}

- Name: LoadSubIDs
  Type: Loader
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [13]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        MultipleThreadsPerCollection: true
        CollectionCount: 1
        DocumentCount: 4800
        BatchSize: 1000
        Document:
          _id: {id1: {^Inc: {start: 0, step: 1}}, id2: {^Inc: {start: 0, step: 1}}}

- ActorFromTemplate:
    TemplateName: IDHACK
    TemplateParameters:
      Name: IDHackOnSubID5Threads
      Threads: 5
      OnlyActiveInPhase: 15
      Filter: {_id: {_id1: {^RandomInt: {min: 0, max: 4799}}, _id2: {^RandomInt: {min: 0, max: 4799}}}}

- ActorFromTemplate:
    TemplateName: IDHACK
    TemplateParameters:
      Name: IDHackOnSubID15Threads
      Threads: 15
      OnlyActiveInPhase: 16
      Filter: {_id: {_id1: {^RandomInt: {min: 0, max: 4799}}, _id2: {^RandomInt: {min: 0, max: 4799}}}}

- ActorFromTemplate:
    TemplateName: IDHACK
    TemplateParameters:
      Name: IDHackOnSubID30Threads
      Threads: 30
      OnlyActiveInPhase: 17
      Filter: {_id: {_id1: {^RandomInt: {min: 0, max: 4799}}, _id2: {^RandomInt: {min: 0, max: 4799}}}}

- Name: LoadLargerDocs
  Type: Loader
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [19]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        MultipleThreadsPerCollection: true
        CollectionCount: 1
        DocumentCount: 4800
        BatchSize: 1000
        Document:
          _id: {^Inc: {start: 0, step: 1}}
          extraData: {^Object: {
            withNEntries: {^RandomInt: {min: 5, max: 200}},
            havingKeys: {^RandomString: {length: 10}},
            andValues: 0,
            duplicatedKeys: skip
          }}

- ActorFromTemplate:
    TemplateName: IDHACK
    TemplateParameters:
      Name: IDHackOnLargeDocs5Threads
      Threads: 5
      OnlyActiveInPhase: 21
      Filter: {_id: {^RandomInt: {min: 0, max: 4799}}}

- ActorFromTemplate:
    TemplateName: IDHACK
    TemplateParameters:
      Name: IDHackOnLargeDocs15Threads
      Threads: 15
      OnlyActiveInPhase: 22
      Filter: {_id: {^RandomInt: {min: 0, max: 4799}}}

- ActorFromTemplate:
    TemplateName: IDHACK
    TemplateParameters:
      Name: IDHackLargeDocs30Threads
      Threads: 30
      OnlyActiveInPhase: 23
      Filter: {_id: {^RandomInt: {min: 0, max: 4799}}}