SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  TODO document me
  PERF-5111

  The goal of this test is to exercise multiplanning. We create as many indexes as possible, and run a
  query that makes all of them eligible, so we get as many competing plans as possible.

  The original goal of this test was to demonstrate weaknesses of the SBE multiplanner when compared to
  the classic multiplanner. Mainly, the SBE multiplanner can't round-robin between plans, which means it
  has to run the list of plans sequentially, which means we can't short-circuit when the shortest-running
  plan finishes.

GlobalDefaults:
  dbname: &db test
  # TODO document me: isn't there an implicit dependency where one of the actors hardcodes
  # 'Collection0' because it follows the pattern 'Collection<N>' ?
  coll: &coll Collection0

  docCount: &docCount 10

  numPhases: &numPhases 3

  nop: &Nop {Nop: true}


ActorTemplates:
- TemplateName: CreateDataset
  Config:
    Name: "CreateDataset"
    Type: Loader
    Threads: 1
    Phases:
      OnlyActiveInPhases:
        Active: [{^Parameter: {Name: "OnlyActiveInPhase", Default: 1024}}]
        NopInPhasesUpTo: *numPhases
        PhaseConfig:
          Threads: 1
          Repeat: 1
          Database: *db
          CollectionCount: 1
          DocumentCount: *docCount
          BatchSize: 1000
          Document:
            _id: {^Inc: {start: 0}}
            # TODO uniform
            a: {^RandomDouble: {distribution: normal, mean: 50.0, sigma: 10.0}}

Actors:
- Name: CleanStart
  Type: RunCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: *numPhases
      PhaseConfig:
        Repeat: 1
        Database: *db
        Operations:
        - OperationName: RunCommand
          OperationCommand:
            drop: Collection0

- ActorFromTemplate:
    TemplateName: CreateDataset
    TemplateParameters:
      OnlyActiveInPhase: 1

- Name: Quiesce
  Type: QuiesceActor
  Threads: 1
  Database: *db
  Phases:
  - *Nop
  - *Nop
  - Repeat: 1
  - *Nop

- Name: Queries
  Type: CrudActor
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - Repeat: 2
    Database: *db
    Collection: *coll
    Operations:
    - OperationMetricsName: HelloIAmATeapot # TODO
      OperationName: aggregate
      OperationCommand:
        Pipeline: [
          {$sort: {m: 1, t: 1}},
          {$_internalInhibitOptimization: {}},
          {$skip: 1e10},
        ]
        Hint: {m: 1, t: 1}

AutoRun:
- When:
    mongodb_setup:
      # TODO consider which configurations
      $eq:
      - replica
      - replica-all-feature-flags
    branch_name:
      # TODO update this list
      $neq:
      - v4.0
      - v4.2
      - v4.4
      - v5.0
      - v5.1
      - v5.2
      - v5.3
