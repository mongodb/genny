SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  This workloads covers $group queries with distinct-like semantics, meaning that only a single document
  is selected from each group. Depending on the details of the query and available indexes, the query might
  be optimized to use DISTINCT_SCAN plan.

Clients:
  Default:
    QueryOptions:
      maxPoolSize: 2000

Keywords:
- Distinct
- Group
- First
- Last
- Top
- Bottom

GlobalDefaults:
  Database: &Database test
  Collection: &Collection Collection0
  MaxPhases: &MaxPhases 11

ActorTemplates:
- TemplateName: RunAggCommand
  Config:
    Name: {^Parameter: {Name: "Name", Default: "RunAggCommand"}}
    Type: CrudActor
    Database: *Database
    Threads: 32
    Phases:
      OnlyActiveInPhases:
        Active: [{^Parameter: {Name: "OnlyActiveInPhase", Default: {unused: "please specify in which phases this actor should be active."}}}]
        NopInPhasesUpTo: *MaxPhases
        PhaseConfig:
          Repeat: 100
          Collection: *Collection
          Operations:
          - OperationName: aggregate
            OperationCommand:
              Pipeline: {^Parameter: {Name: "Pipeline", Default: []}}

Actors:
# Clear any pre-existing collection state.
- Name: ClearCollection
  Type: CrudActor
  Database: *Database
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Threads: 1
        Collection: *Collection
        Operations:
        - OperationName: drop

- Name: InsertData
  Type: Loader
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        MultipleThreadsPerCollection: true
        CollectionCount: 1
        DocumentCount: 5000
        BatchSize: 1000
        Document:
          _id: {^Inc: {start: 0, step: 1}}
          a: {^RandomInt: {min: 0, max: 100}}
          b: {^RandomInt: {min: 0, max: 100}}
          c: {^RandomInt: {min: 0, max: 100}}
        Indexes:
          - keys: {a: 1, b: 1, c: 1}

# The following use a DISTINCT_SCAN.
- ActorFromTemplate:
    TemplateName: RunAggCommand
    TemplateParameters:
      Name: "Group"
      OnlyActiveInPhase: 2
      Pipeline: [{$group: {_id: "$a"}}]

- ActorFromTemplate:
    TemplateName: RunAggCommand
    TemplateParameters:
      Name: "GroupSort"
      OnlyActiveInPhase: 3
      Pipeline: [{$sort: {a: 1}}, {$group: {_id: "$a"}}]

- ActorFromTemplate:
    TemplateName: RunAggCommand
    TemplateParameters:
      Name: "GroupSortFirst"
      OnlyActiveInPhase: 4
      Pipeline: [{$sort: {a: 1, b: 1}}, {$group: {_id: "$a", accum: {$first: "$b"}}}]

- ActorFromTemplate:
    TemplateName: RunAggCommand
    TemplateParameters:
      Name: "GroupSortFirstFullDocument"
      OnlyActiveInPhase: 5
      Pipeline: [{$sort: {a: 1, b: 1}}, {$group: {_id: "$a", accum: {$first: "$$ROOT"}}}]

- ActorFromTemplate:
    TemplateName: RunAggCommand
    TemplateParameters:
      Name: "GroupSortLast"
      OnlyActiveInPhase: 6
      Pipeline: [{$sort: {a: 1, b: 1}}, {$group: {_id: "$a", accum: {$last: "$b"}}}]

- ActorFromTemplate:
    TemplateName: RunAggCommand
    TemplateParameters:
      Name: "GroupSortLastFullDocument"
      OnlyActiveInPhase: 7
      Pipeline: [{$sort: {a: 1, b: 1}}, {$group: {_id: "$a", accum: {$last: "$$ROOT"}}}]

# The following do not yet use DISTINCT_SCAN, but they will after SERVER-84347.
- ActorFromTemplate:
    TemplateName: RunAggCommand
    TemplateParameters:
      Name: "GroupTop"
      OnlyActiveInPhase: 8
      Pipeline: [{$group: {_id: "$a", accum: {$top: {output: ["$b"], sortBy: {b: 1}}}}}]

- ActorFromTemplate:
    TemplateName: RunAggCommand
    TemplateParameters:
      Name: "GroupBottom"
      OnlyActiveInPhase: 9
      Pipeline: [{$group: {_id: "$a", accum: {$bottom: {output: ["$b"], sortBy: {b: 1}}}}}]

- ActorFromTemplate:
    TemplateName: RunAggCommand
    TemplateParameters:
      Name: "GroupTopN"
      OnlyActiveInPhase: 10
      Pipeline: [{$group: {_id: "$a", accum: {$topN: {n: 1, output: ["$b"], sortBy: {b: 1}}}}}]

- ActorFromTemplate:
    TemplateName: RunAggCommand
    TemplateParameters:
      Name: "GroupBottomN"
      OnlyActiveInPhase: 11
      Pipeline: [{$group: {_id: "$a", accum: {$bottomN: {n: 1, output: ["$b"], sortBy: {b: 1}}}}}]

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - replica
      - replica-all-feature-flags
