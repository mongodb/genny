# Sharded collection -> Distributed chunk processing
# coll -> $out (tests raw output)
# coll -> coll updated with a new field (counter that starts at 0) not susceptible to halloween since it doesn't change recordid
# coll -> coll with different shard key updated with a new field (counter that starts at 0) not susceptible to halloween since it doesn't change recordid
# coll -> newColl with a new field (counter that starts at 0) non-merging output to new collection
#         sharded and non-sharded versions

# Same for unsharded
# All of this with 1, 4, 16 threads AND 1k, 4k, 16k documents. 10k documents per collection should be enough
# Repeat 5 times for value stability





SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  This test exercises the behavior of $lookup when the local and foreign collection data is
  co-located. In the queries below, for each local document on each shard, the $lookup subpipeline
  is targeted to the same shard.
  The workload consists of the following steps:
    A. Creating empty collections, some unsharded and some sharded.
    B. Populating collections with data.
    C. Fsync.
    D. Running $lookups. This includes pipelines using let/pipeline syntax, pipelines with
       local/foreign field syntax, pipelines with different $limits, and pipelines run against
       sharded and unsharded colls.
GlobalDefaults:
  Unsharded1K: &Unsharded1K Unsharded1K
  Unsharded4K: &Unsharded4K Unsharded4K
  Unsharded16K: &Unsharded16K Unsharded16K
  Sharded1K: &Sharded1K Sharded1K
  Sharded4K: &Sharded4K Sharded4K
  Sharded16K: &Sharded16K Sharded16K
  Sharded1KNSS: &Sharded1KNSS test.Sharded1K
  Sharded4KNSS: &Sharded4KNSS test.Sharded4K
  Sharded16KNSS: &Sharded16KNSS test.Sharded16K
  NumDocs: &NumDocs 10_000
  Database: &Database test
  NumPhases: &NumPhases 100
  NumCombinations: &NumCombinations 18 # 3 threads * 3 data sizes * 2 collection source types

Clients:
  Default:
    QueryOptions:
      maxPoolSize: 1024

Documents:
  Document1K: &1KDoc
    shardKey: {^RandomInt: {min: 0, max: 16}}
    text: {^FastRandomString: {length: 1024}}
  Document4K: &4KDoc
    shardKey: {^RandomInt: {min: 0, max: 16}}
    text: {^FastRandomString: {length: 4096}}
  Document16K: &16KDoc
    shardKey: {^RandomInt: {min: 0, max: 16}}
    text: {^FastRandomString: {length: 16384}}

ShardedCollections:
  - &ShardedCollOutput1 ShardedCollOutput1
  - &ShardedCollOutput2 ShardedCollOutput2
  - &ShardedCollOutput3 ShardedCollOutput3
  - &ShardedCollOutput4 ShardedCollOutput4
  - &ShardedCollOutput5 ShardedCollOutput5
  - &ShardedCollOutput6 ShardedCollOutput6
  - &ShardedCollOutput7 ShardedCollOutput7
  - &ShardedCollOutput8 ShardedCollOutput8
  - &ShardedCollOutput9 ShardedCollOutput9
  - &ShardedCollOutput10 ShardedCollOutput10
  - &ShardedCollOutput11 ShardedCollOutput11
  - &ShardedCollOutput12 ShardedCollOutput12
  - &ShardedCollOutput13 ShardedCollOutput13
  - &ShardedCollOutput14 ShardedCollOutput14
  - &ShardedCollOutput15 ShardedCollOutput15
  - &ShardedCollOutput16 ShardedCollOutput16
  - &ShardedCollOutput17 ShardedCollOutput17
  - &ShardedCollOutput18 ShardedCollOutput18

ActorTemplates:
- TemplateName: AggregationActor
  Config:
    Name: {^PreprocessorFormatString: {format: "%s_%d_threads", withArgs: [{^Parameter: {Name: "SrcCollection", Default: Collection0}}, {^Parameter: {Name: "Threads", Default: 1}}]}}
    Type: CrudActor
    Database: *Database
    Threads: {^Parameter: {Name: "Threads", Default: 1}}
    Phases:
    - Phase: {^PreprocessorFormatString: {format: "0..%d", withArgs: [{^Parameter: {Name: StartsAt, Default: 2}}]}}
      Nop: true
    - Repeat: {^Parameter: {Name: "Repeat", Default: 5}}
      Database: *Database
      Collection: {^Parameter: {Name: "SrcCollection", Default: Collection0}}
      Operations:
      - OperationMetricsName: {^PreprocessorFormatString: {format: "%s_out_%d", withArgs: [{^Parameter: {Name: "SrcCollection", Default: Collection0}}, {^Parameter: {Name: "Threads", Default: 1}}]}}
        OperationName: aggregate
        OperationCommand:
          Pipeline: [{$out: {^FormatString: {format: "%d", withArgs: [{^ActorId: {}}]}}}]
    - Phase: {^PreprocessorFormatString: {format: "%d..%d", withArgs: [
        {^NumExpr: {withExpression: "startsAt + 2", andValues: {startsAt: {^Parameter: {Name: StartsAt, Default: 2}}}}},
        {^NumExpr: {withExpression: "startsAt + 2 + numCombinations - 1", andValues: {startsAt: {^Parameter: {Name: StartsAt, Default: 2}}, numCombinations: {^Parameter: {Name: NumCombinations, Default: 1}}}}}
      ]}}
      Nop: true
    - Repeat: {^Parameter: {Name: "Repeat", Default: 5}}
      Database: *Database
      Collection: {^Parameter: {Name: "SrcCollection", Default: Collection0}}
      Operations:
      - OperationMetricsName: {^PreprocessorFormatString: {format: "%s_newField_%d", withArgs: [{^Parameter: {Name: "SrcCollection", Default: Collection0}}, {^Parameter: {Name: "Threads", Default: 1}}]}}
        OperationName: aggregate
        OperationCommand:
          Pipeline: [
            {$addFields: {counter: {$add: [1, '$counter']}}},
            {$merge: {into: {^Parameter: {Name: "SrcCollection", Default: Collection0}}}}
          ]
    - Phase: {^PreprocessorFormatString: {format: "%d..%d", withArgs: [
        {^NumExpr: {withExpression: "startsAt + 2 + numCombinations * 1 + 1", andValues: {startsAt: {^Parameter: {Name: StartsAt, Default: 2}}, numCombinations: {^Parameter: {Name: NumCombinations, Default: 1}}}}},
        {^NumExpr: {withExpression: "startsAt + 2 + numCombinations * 2 + 0", andValues: {startsAt: {^Parameter: {Name: StartsAt, Default: 2}}, numCombinations: {^Parameter: {Name: NumCombinations, Default: 1}}}}}
      ]}}
      Nop: true
    - Repeat: {^Parameter: {Name: "Repeat", Default: 5}}
      Database: *Database
      Collection: {^Parameter: {Name: "SrcCollection", Default: Collection0}}
      Operations:
      - OperationMetricsName: {^PreprocessorFormatString: {format: "%s_newFieldWithShardKeyChange_%d", withArgs: [{^Parameter: {Name: "SrcCollection", Default: Collection0}}, {^Parameter: {Name: "Threads", Default: 1}}]}}
        OperationName: aggregate
        OperationCommand:
          Pipeline: [
            {$addFields: {counter: {$add: [1, '$counter']}, shardKey: {$add: [1, '$shardKey']}}},
            {$merge: {into: {^Parameter: {Name: "SrcCollection", Default: Collection0}}}}
          ]
    - Phase: {^PreprocessorFormatString: {format: "%d..%d", withArgs: [
        {^NumExpr: {withExpression: "startsAt + 2 + numCombinations * 2 + 2", andValues: {startsAt: {^Parameter: {Name: StartsAt, Default: 2}}, numCombinations: {^Parameter: {Name: NumCombinations, Default: 1}}}}},
        {^NumExpr: {withExpression: "startsAt + 2 + numCombinations * 3 + 1", andValues: {startsAt: {^Parameter: {Name: StartsAt, Default: 2}}, numCombinations: {^Parameter: {Name: NumCombinations, Default: 1}}}}}
      ]}}
      Nop: true
    - Repeat: {^Parameter: {Name: "Repeat", Default: 5}}
      Database: *Database
      Collection: {^Parameter: {Name: "SrcCollection", Default: Collection0}}
      Operations:
      - OperationMetricsName: {^PreprocessorFormatString: {format: "%s_mergeToNewCollUnsharded_%d", withArgs: [{^Parameter: {Name: "SrcCollection", Default: Collection0}}, {^Parameter: {Name: "Threads", Default: 1}}]}}
        OperationName: aggregate
        OperationCommand:
          Pipeline: [
            {$addFields: {counter: {$add: [1, '$counter']}, shardKey: {$add: [1, '$shardKey']}}},
            {$merge: {into: {^FormatString: {format: "%d", withArgs: [{^ActorId: {}}]}}}}
          ]
    - Phase: {^PreprocessorFormatString: {format: "%d..%d", withArgs: [
        {^NumExpr: {withExpression: "startsAt + 2 + numCombinations * 3 + 3", andValues: {startsAt: {^Parameter: {Name: StartsAt, Default: 2}}, numCombinations: {^Parameter: {Name: NumCombinations, Default: 1}}}}},
        {^NumExpr: {withExpression: "startsAt + 2 + numCombinations * 4 + 2", andValues: {startsAt: {^Parameter: {Name: StartsAt, Default: 2}}, numCombinations: {^Parameter: {Name: NumCombinations, Default: 1}}}}}
      ]}}
      Nop: true
    - Repeat: {^Parameter: {Name: "Repeat", Default: 5}}
      Database: *Database
      Collection: {^Parameter: {Name: "SrcCollection", Default: Collection0}}
      Operations:
      - OperationMetricsName: {^PreprocessorFormatString: {format: "%s_mergeToNewCollSharded_%d", withArgs: [{^Parameter: {Name: "SrcCollection", Default: Collection0}}, {^Parameter: {Name: "Threads", Default: 1}}]}}
        OperationName: aggregate
        OperationCommand:
          Pipeline: [
            {$addFields: {counter: {$add: [1, '$counter']}, shardKey: {$add: [1, '$shardKey']}}},
            {$merge: {into: {^Parameter: {Name: ShardedCollOutput, Default: *ShardedCollOutput1}}}}
          ]
    - Phase: {^PreprocessorFormatString: {format: "%d..%d", withArgs: [
        {^NumExpr: {withExpression: "startsAt + 2 + numCombinations * 4 + 4", andValues: {startsAt: {^Parameter: {Name: StartsAt, Default: 2}}, numCombinations: {^Parameter: {Name: NumCombinations, Default: 1}}}}},
        *NumPhases
      ]}}
      Nop: true
Actors:
- Name: Unsharded1KLoader
  Type: MonotonicSingleLoader
  Threads: 5
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        Collection: *Unsharded1K
        DocumentCount: *NumDocs
        BatchSize: 100
        Document: *1KDoc
- Name: Unsharded4KLoader
  Type: MonotonicSingleLoader
  Threads: 5
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        Collection: *Unsharded4K
        DocumentCount: *NumDocs
        BatchSize: 100
        Document: *4KDoc
- Name: Unsharded16KLoader
  Type: MonotonicSingleLoader
  Threads: 5
  Phases:
    OnlyActiveInPhases: 
      Active: [1]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        Collection: *Unsharded16K
        DocumentCount: *NumDocs
        BatchSize: 100
        Document: *16KDoc

- Name: ShardCollection
  Type: AdminCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        # Until EVG-21054 is resolved, using OnlyRunInInstance requires excluding the workload from dry-runs
        OnlyRunInInstance: sharded
        Repeat: 1
        Operations:
        - OperationName: AdminCommand
          OperationMetricsName: EnableShardingMetrics
          OperationCommand:
            enableSharding: *Database
        - OperationName: AdminCommand
          OperationMetricsName: ShardCollection1KMetrics
          OperationCommand:
            shardCollection: *Sharded1KNSS
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationMetricsName: ShardCollection4KMetrics
          OperationCommand:
            shardCollection: *Sharded4KNSS
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationMetricsName: ShardCollection16KMetrics
          OperationCommand:
            shardCollection: *Sharded16KNSS
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput1]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput2]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput3]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput4]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput5]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput6]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput7]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput8]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput9]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput10]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput11]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput12]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput13]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput14]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput15]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput16]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput17]}}
            key: {shardKey: "hashed"}
        - OperationName: AdminCommand
          OperationCommand:
            shardCollection: {^PreprocessorFormatString: {format: "test.%s", withArgs: [*ShardedCollOutput18]}}
            key: {shardKey: "hashed"}
# TODO: Make a lot of sharded collections
- Name: Sharded1KLoader
  Type: MonotonicSingleLoader
  Threads: 5
  Phases:
    OnlyActiveInPhases:
      Active: [2]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        Collection: *Sharded1K
        DocumentCount: *NumDocs
        BatchSize: 100
        Document: *1KDoc
- Name: Sharded4KLoader
  Type: MonotonicSingleLoader
  Threads: 5
  Phases:
    OnlyActiveInPhases:
      Active: [2]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        Collection: *Sharded4K
        DocumentCount: *NumDocs
        BatchSize: 100
        Document: *4KDoc
- Name: Sharded16KLoader
  Type: MonotonicSingleLoader
  Threads: 5
  Phases:
    OnlyActiveInPhases:
      Active: [2]
      NopInPhasesUpTo: *NumPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        Collection: *Sharded16K
        DocumentCount: *NumDocs
        BatchSize: 100
        Document: *16KDoc

- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 1
      SrcCollection: *Unsharded1K
      StartsAt: 2
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput1
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 1
      SrcCollection: *Unsharded4K
      StartsAt: 3
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput2
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 1
      SrcCollection: *Unsharded16K
      StartsAt: 4
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput3
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 4
      SrcCollection: *Unsharded1K
      StartsAt: 5
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput4
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 4
      SrcCollection: *Unsharded4K
      StartsAt: 6
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput5
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 4
      SrcCollection: *Unsharded16K
      StartsAt: 7
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput6
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 16
      SrcCollection: *Unsharded1K
      StartsAt: 8
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput7
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 16
      SrcCollection: *Unsharded4K
      StartsAt: 9
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput8
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 16
      SrcCollection: *Unsharded16K
      StartsAt: 10
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput9

# Sharded colls
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 1
      SrcCollection: *Sharded1K
      StartsAt: 11
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput10
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 1
      SrcCollection: *Sharded4K
      StartsAt: 12
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput11
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 1
      SrcCollection: *Sharded16K
      StartsAt: 13
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput12
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 4
      SrcCollection: *Sharded1K
      StartsAt: 14
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput13
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 4
      SrcCollection: *Sharded4K
      StartsAt: 15
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput14
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 4
      SrcCollection: *Sharded16K
      StartsAt: 16
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput15
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 16
      SrcCollection: *Sharded1K
      StartsAt: 17
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput16
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 16
      SrcCollection: *Sharded4K
      StartsAt: 18
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput17
- ActorFromTemplate:
    TemplateName: AggregationActor
    TemplateParameters:
      Threads: 16
      SrcCollection: *Sharded16K
      StartsAt: 19
      NumCombinations: *NumCombinations
      ShardedCollOutput: *ShardedCollOutput18
