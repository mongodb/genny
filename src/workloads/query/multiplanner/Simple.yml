SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  The goal of this test is to exercise multiplanning. We create as many indexes as possible, and run a
  query that makes all of them eligible, so we get as many competing plans as possible.

  The original goal of this test was to demonstrate weaknesses of the SBE multiplanner when compared to
  the classic multiplanner. Mainly, the SBE multiplanner can't round-robin between plans, which means it
  has to run the list of plans sequentially, which means we can't short-circuit when the shortest-running
  plan finishes.

GlobalDefaults:
  dbname: &db test
  # Collection name used for queries.
  # Note the 'Loader' actor also hardcodes this name, so it's not actually free to change.
  coll: &coll Collection0

  # At time of writing it takes about a minute to generate this dataset locally.
  docCount: &docCount 1000000
  resultCount: &resultCount 101
  selectivity: &selectivity {^NumExpr: {withExpression: "resultCount / docCount", andValues: {resultCount: *resultCount, docCount: *docCount}}}

  maxPhase: &maxPhase 7

  nop: &Nop {Nop: true}

Actors:
# TODO other workloads clean up at the end. does this matter?
- Name: CleanStart
  Type: RunCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: *maxPhase
      PhaseConfig:
        Repeat: 1
        Database: *db
        Operations:
        - OperationName: RunCommand
          OperationCommand:
            drop: Collection0

- Name: "CreateDataset"
  Type: Loader
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: *maxPhase
      PhaseConfig:
        Threads: 1
        Repeat: 1
        Database: *db
        CollectionCount: 1
        DocumentCount: *docCount
        BatchSize: 1000
        Document:
          # Seems unnecessary to provide explicit _id ?
          # _id: {^Inc: {start: 0}}
          x1: &distribution {^RandomDouble: {distribution: uniform, min: 0.0, max: 1.0}}
          x2: *distribution
          x3: *distribution
          x4: *distribution
          x5: *distribution
          x6: *distribution
          x7: *distribution
          x8: *distribution
          x9: *distribution
          x10: *distribution
          x11: *distribution
          x12: *distribution
          x13: *distribution
          x14: *distribution
          x15: *distribution
          x16: *distribution
          x17: *distribution
          x18: *distribution
          x19: *distribution
          x20: *distribution
          x21: *distribution
          x22: *distribution
          x23: *distribution
          x24: *distribution
          x25: *distribution
          x26: *distribution
          x27: *distribution
          x28: *distribution
          x29: *distribution
          x30: *distribution
          x31: *distribution
          x32: *distribution
          x33: *distribution
          x34: *distribution
          x35: *distribution
          x36: *distribution
          x37: *distribution
          x38: *distribution
          x39: *distribution
          x40: *distribution
          x41: *distribution
          x42: *distribution
          x43: *distribution
          x44: *distribution
          x45: *distribution
          x46: *distribution
          x47: *distribution
          x48: *distribution
          x49: *distribution
          x50: *distribution
          x51: *distribution
          x52: *distribution
          x53: *distribution
          x54: *distribution
          x55: *distribution
          x56: *distribution
          x57: *distribution
          x58: *distribution
          x59: *distribution
          x60: *distribution
          x61: *distribution
          x62: *distribution
          x63: *distribution
        Indexes:
          - keys: {x1: 1}
          - keys: {x2: 1}
          - keys: {x3: 1}
          - keys: {x4: 1}
          - keys: {x5: 1}
          - keys: {x6: 1}
          - keys: {x7: 1}
          - keys: {x8: 1}
          - keys: {x9: 1}
          - keys: {x10: 1}
          - keys: {x11: 1}
          - keys: {x12: 1}
          - keys: {x13: 1}
          - keys: {x14: 1}
          - keys: {x15: 1}
          - keys: {x16: 1}
          - keys: {x17: 1}
          - keys: {x18: 1}
          - keys: {x19: 1}
          - keys: {x20: 1}
          - keys: {x21: 1}
          - keys: {x22: 1}
          - keys: {x23: 1}
          - keys: {x24: 1}
          - keys: {x25: 1}
          - keys: {x26: 1}
          - keys: {x27: 1}
          - keys: {x28: 1}
          - keys: {x29: 1}
          - keys: {x30: 1}
          - keys: {x31: 1}
          - keys: {x32: 1}
          - keys: {x33: 1}
          - keys: {x34: 1}
          - keys: {x35: 1}
          - keys: {x36: 1}
          - keys: {x37: 1}
          - keys: {x38: 1}
          - keys: {x39: 1}
          - keys: {x40: 1}
          - keys: {x41: 1}
          - keys: {x42: 1}
          - keys: {x43: 1}
          - keys: {x44: 1}
          - keys: {x45: 1}
          - keys: {x46: 1}
          - keys: {x47: 1}
          - keys: {x48: 1}
          - keys: {x49: 1}
          - keys: {x50: 1}
          - keys: {x51: 1}
          - keys: {x52: 1}
          - keys: {x53: 1}
          - keys: {x54: 1}
          - keys: {x55: 1}
          - keys: {x56: 1}
          - keys: {x57: 1}
          - keys: {x58: 1}
          - keys: {x59: 1}
          - keys: {x60: 1}
          - keys: {x61: 1}
          - keys: {x62: 1}
          - keys: {x63: 1}

- Name: Quiesce
  Type: QuiesceActor
  Threads: 1
  Database: *db
  Phases:
  - *Nop
  - *Nop
  - Repeat: 1
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

- Name: Queries
  Type: CrudActor
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - Repeat: 2
    Database: *db
    Collection: *coll
    Operations:
    - OperationMetricsName: RunQueries
      OperationName: find
      OperationCommand:
        Filter:
          x1: {$lt: *selectivity}
          x2: {$lte: 1}
          x3: {$lte: 1}
          x4: {$lte: 1}
          x5: {$lte: 1}
          x6: {$lte: 1}
          x7: {$lte: 1}
          x8: {$lte: 1}
          x9: {$lte: 1}
          x10: {$lte: 1}
          x11: {$lte: 1}
          x12: {$lte: 1}
          x13: {$lte: 1}
          x14: {$lte: 1}
          x15: {$lte: 1}
          x16: {$lte: 1}
          x17: {$lte: 1}
          x18: {$lte: 1}
          x19: {$lte: 1}
          x20: {$lte: 1}
          x21: {$lte: 1}
          x22: {$lte: 1}
          x23: {$lte: 1}
          x24: {$lte: 1}
          x25: {$lte: 1}
          x26: {$lte: 1}
          x27: {$lte: 1}
          x28: {$lte: 1}
          x29: {$lte: 1}
          x30: {$lte: 1}
          x31: {$lte: 1}
          x32: {$lte: 1}
          x33: {$lte: 1}
          x34: {$lte: 1}
          x35: {$lte: 1}
          x36: {$lte: 1}
          x37: {$lte: 1}
          x38: {$lte: 1}
          x39: {$lte: 1}
          x40: {$lte: 1}
          x41: {$lte: 1}
          x42: {$lte: 1}
          x43: {$lte: 1}
          x44: {$lte: 1}
          x45: {$lte: 1}
          x46: {$lte: 1}
          x47: {$lte: 1}
          x48: {$lte: 1}
          x49: {$lte: 1}
          x50: {$lte: 1}
          x51: {$lte: 1}
          x52: {$lte: 1}
          x53: {$lte: 1}
          x54: {$lte: 1}
          x55: {$lte: 1}
          x56: {$lte: 1}
          x57: {$lte: 1}
          x58: {$lte: 1}
          x59: {$lte: 1}
          x60: {$lte: 1}
          x61: {$lte: 1}
          x62: {$lte: 1}
          x63: {$lte: 1}
  - *Nop
  - Repeat: 2
    Database: *db
    Collection: *coll
    Operations:
    - OperationMetricsName: RunQueries
      OperationName: find
      OperationCommand:
        Filter:
          x1: {$lt: *selectivity}
          x2: {$lte: 1}
          x3: {$lte: 1}
          x4: {$lte: 1}
          x5: {$lte: 1}
          x6: {$lte: 1}
          x7: {$lte: 1}
          x8: {$lte: 1}
          x9: {$lte: 1}
          x10: {$lte: 1}
          x11: {$lte: 1}
          x12: {$lte: 1}
          x13: {$lte: 1}
          x14: {$lte: 1}
          x15: {$lte: 1}
          x16: {$lte: 1}
          x17: {$lte: 1}
          x18: {$lte: 1}
          x19: {$lte: 1}
          x20: {$lte: 1}
          x21: {$lte: 1}
          x22: {$lte: 1}
          x23: {$lte: 1}
          x24: {$lte: 1}
          x25: {$lte: 1}
          x26: {$lte: 1}
          x27: {$lte: 1}
          x28: {$lte: 1}
          x29: {$lte: 1}
          x30: {$lte: 1}
          x31: {$lte: 1}
          x32: {$lte: 1}
          x33: {$lte: 1}
          x34: {$lte: 1}
          x35: {$lte: 1}
          x36: {$lte: 1}
          x37: {$lte: 1}
          x38: {$lte: 1}
          x39: {$lte: 1}
          x40: {$lte: 1}
          x41: {$lte: 1}
          x42: {$lte: 1}
          x43: {$lte: 1}
          x44: {$lte: 1}
          x45: {$lte: 1}
          x46: {$lte: 1}
          x47: {$lte: 1}
          x48: {$lte: 1}
          x49: {$lte: 1}
          x50: {$lte: 1}
          x51: {$lte: 1}
          x52: {$lte: 1}
          x53: {$lte: 1}
          x54: {$lte: 1}
          x55: {$lte: 1}
          x56: {$lte: 1}
          x57: {$lte: 1}
          x58: {$lte: 1}
          x59: {$lte: 1}
          x60: {$lte: 1}
          x61: {$lte: 1}
          x62: {$lte: 1}
          x63: {$lte: 1}
  - *Nop
  - Repeat: 2
    Database: *db
    Collection: *coll
    Operations:
    - OperationMetricsName: RunQueries
      OperationName: find
      OperationCommand:
        Filter:
          x1: {$lt: *selectivity}
          x2: {$lte: 1}
          x3: {$lte: 1}
          x4: {$lte: 1}
          x5: {$lte: 1}
          x6: {$lte: 1}
          x7: {$lte: 1}
          x8: {$lte: 1}
          x9: {$lte: 1}
          x10: {$lte: 1}
          x11: {$lte: 1}
          x12: {$lte: 1}
          x13: {$lte: 1}
          x14: {$lte: 1}
          x15: {$lte: 1}
          x16: {$lte: 1}
          x17: {$lte: 1}
          x18: {$lte: 1}
          x19: {$lte: 1}
          x20: {$lte: 1}
          x21: {$lte: 1}
          x22: {$lte: 1}
          x23: {$lte: 1}
          x24: {$lte: 1}
          x25: {$lte: 1}
          x26: {$lte: 1}
          x27: {$lte: 1}
          x28: {$lte: 1}
          x29: {$lte: 1}
          x30: {$lte: 1}
          x31: {$lte: 1}
          x32: {$lte: 1}
          x33: {$lte: 1}
          x34: {$lte: 1}
          x35: {$lte: 1}
          x36: {$lte: 1}
          x37: {$lte: 1}
          x38: {$lte: 1}
          x39: {$lte: 1}
          x40: {$lte: 1}
          x41: {$lte: 1}
          x42: {$lte: 1}
          x43: {$lte: 1}
          x44: {$lte: 1}
          x45: {$lte: 1}
          x46: {$lte: 1}
          x47: {$lte: 1}
          x48: {$lte: 1}
          x49: {$lte: 1}
          x50: {$lte: 1}
          x51: {$lte: 1}
          x52: {$lte: 1}
          x53: {$lte: 1}
          x54: {$lte: 1}
          x55: {$lte: 1}
          x56: {$lte: 1}
          x57: {$lte: 1}
          x58: {$lte: 1}
          x59: {$lte: 1}
          x60: {$lte: 1}
          x61: {$lte: 1}
          x62: {$lte: 1}
          x63: {$lte: 1}  
  
- Name: Hide48Indexes
  Type: RunCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [4]
      NopInPhasesUpTo: *maxPhase
      PhaseConfig:
        Repeat: 1
        Database: *db
        Collection: *coll
        Operations:
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x17: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x18: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x19: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x20: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x21: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x22: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x23: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x24: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x25: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x26: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x27: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x28: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x29: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x30: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x31: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x32: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x33: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x34: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x35: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x36: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x37: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x38: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x39: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x40: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x41: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x42: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x43: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x44: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x45: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x46: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x47: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x48: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x49: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x50: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x51: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x52: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x53: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x54: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x55: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x56: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x57: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x58: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x59: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x60: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x61: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x62: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x63: 1}
              hidden: true

- Name: Hide14Indexes
  Type: RunCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [6]
      NopInPhasesUpTo: *maxPhase
      PhaseConfig:
        Repeat: 1
        Database: *db
        Collection: *coll
        Operations:
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x3: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x4: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x5: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x6: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x7: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x8: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x9: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x10: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x11: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x12: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x13: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x14: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x15: 1}
              hidden: true
        - OperationName: RunCommand
          OperationCommand:
            collMod: *coll
            index:
              keyPattern: {x16: 1}
              hidden: true

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone  # At time of writing this will be SBE.
      - standalone-all-feature-flags  # At time of writing this will enable PM-3591.
      - standalone-classic-query-engine
    branch_name:
      $gte: v7.3
