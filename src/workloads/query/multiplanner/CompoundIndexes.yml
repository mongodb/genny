SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  The goal of this test is to exercise multiplanning. We create as many compound indexes as possible, each
  comprising of tenantId and another field. We then run a query with an equality predicate on tenantId and 
  other predicates a small number of fields, so we get all the plans that use relevant indexes.

  We expect classic to have better latency and throughput than SBE on this workload,
  and we expect the combination of classic planner + SBE execution (PM-3591) to perform about
  as well as classic.

GlobalDefaults:
  dbname: &db test
  # Collection name used for queries.
  coll: &coll Collection0

  docCount: &docCount 1e2
  resultCount: &resultCount 101
  selectivity: &selectivity {^NumExpr: {
    withExpression: "resultCount / docCount",
    andValues: {resultCount: *resultCount, docCount: *docCount}}}

  maxPhase: &maxPhase 7
  queryRepeats: &queryRepeats 1

Actors:
- Name: DropCollection
  Type: RunCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: *maxPhase
      PhaseConfig:
        Repeat: 1
        Database: *db
        Operations:
        - OperationName: RunCommand
          OperationCommand:
            drop: *coll

- Name: SetQueryKnobs
  LoadConfig:
    Path: "../../../phases/query/Multiplanner.yml"
    Key: QueryKnobTemplate
    Parameters:
        # It's ok for this to run in parallel with 'DropCollection'.
        # It has to be a separate actor because they target different DBs.
      active: [0]
      nopInPhasesUpTo: *maxPhase
      collection: *coll

- Name: CreateDataset
  LoadConfig:
    Path: "../../../phases/query/Multiplanner.yml"
    Key: InsertTemplate
    Parameters:
      database: *db
      threads: 1
      active: [1]
      nopInPhasesUpTo: *maxPhase
      repeat: 1
      collection: *coll
      docCount: *docCount
      document: {
        # Genny's random generators appear to be repeatable, so we might as well
        # make '_id' explicit to make the overall dataset repeatable. Omitting
        # '_id' would make it auto-generated based on a timestamp.
        _id: {^Inc: {start: 0}},
        tenantId: {^RandomInt: {distribution: uniform, min: 0, max: 100}},
        x1: &distribution {^RandomDouble: {distribution: uniform, min: 0.0, max: 1.0}},
        x2: *distribution,
        x3: *distribution,
        x4: *distribution,
        x5: *distribution,
        x6: *distribution,
        x7: *distribution,
        x8: *distribution,
        x9: *distribution,
        x10: *distribution,
        x11: *distribution,
        x12: *distribution,
        x13: *distribution,
        x14: *distribution,
        x15: *distribution,
        x16: *distribution,
        x17: *distribution,
        x18: *distribution,
        x19: *distribution,
        x20: *distribution,
        x21: *distribution,
        x22: *distribution,
        x23: *distribution,
        x24: *distribution,
        x25: *distribution,
        x26: *distribution,
        x27: *distribution,
        x28: *distribution,
        x29: *distribution,
        x30: *distribution,
        x31: *distribution,
        x32: *distribution,
        x33: *distribution,
        x34: *distribution,
        x35: *distribution,
        x36: *distribution,
        x37: *distribution,
        x38: *distribution,
        x39: *distribution,
        x40: *distribution,
        x41: *distribution,
        x42: *distribution,
        x43: *distribution,
        x44: *distribution,
        x45: *distribution,
        x46: *distribution,
        x47: *distribution,
        x48: *distribution,
        x49: *distribution,
        x50: *distribution,
        x51: *distribution,
        x52: *distribution,
        x53: *distribution,
        x54: *distribution,
        x55: *distribution,
        x56: *distribution,
        x57: *distribution,
        x58: *distribution,
        x59: *distribution,
        x60: *distribution,
        x61: *distribution,
        x62: *distribution,
        x63: *distribution,
      }
      indexes:
        - keys: {tenantId: 1, x1: 1}
        - keys: {tenantId: 1, x2: 1}
        - keys: {tenantId: 1, x3: 1}
        - keys: {tenantId: 1, x4: 1}
        - keys: {tenantId: 1, x5: 1}
        - keys: {tenantId: 1, x6: 1}
        - keys: {tenantId: 1, x7: 1}
        - keys: {tenantId: 1, x8: 1}
        - keys: {tenantId: 1, x9: 1}
        - keys: {tenantId: 1, x10: 1}
        - keys: {tenantId: 1, x11: 1}
        - keys: {tenantId: 1, x12: 1}
        - keys: {tenantId: 1, x13: 1}
        - keys: {tenantId: 1, x14: 1}
        - keys: {tenantId: 1, x15: 1}
        - keys: {tenantId: 1, x16: 1}
        - keys: {tenantId: 1, x17: 1}
        - keys: {tenantId: 1, x18: 1}
        - keys: {tenantId: 1, x19: 1}
        - keys: {tenantId: 1, x20: 1}
        - keys: {tenantId: 1, x21: 1}
        - keys: {tenantId: 1, x22: 1}
        - keys: {tenantId: 1, x23: 1}
        - keys: {tenantId: 1, x24: 1}
        - keys: {tenantId: 1, x25: 1}
        - keys: {tenantId: 1, x26: 1}
        - keys: {tenantId: 1, x27: 1}
        - keys: {tenantId: 1, x28: 1}
        - keys: {tenantId: 1, x29: 1}
        - keys: {tenantId: 1, x30: 1}
        - keys: {tenantId: 1, x31: 1}
        - keys: {tenantId: 1, x32: 1}
        - keys: {tenantId: 1, x33: 1}
        - keys: {tenantId: 1, x34: 1}
        - keys: {tenantId: 1, x35: 1}
        - keys: {tenantId: 1, x36: 1}
        - keys: {tenantId: 1, x37: 1}
        - keys: {tenantId: 1, x38: 1}
        - keys: {tenantId: 1, x39: 1}
        - keys: {tenantId: 1, x40: 1}
        - keys: {tenantId: 1, x41: 1}
        - keys: {tenantId: 1, x42: 1}
        - keys: {tenantId: 1, x43: 1}
        - keys: {tenantId: 1, x44: 1}
        - keys: {tenantId: 1, x45: 1}
        - keys: {tenantId: 1, x46: 1}
        - keys: {tenantId: 1, x47: 1}
        - keys: {tenantId: 1, x48: 1}
        - keys: {tenantId: 1, x49: 1}
        - keys: {tenantId: 1, x50: 1}
        - keys: {tenantId: 1, x51: 1}
        - keys: {tenantId: 1, x52: 1}
        - keys: {tenantId: 1, x53: 1}
        - keys: {tenantId: 1, x54: 1}
        - keys: {tenantId: 1, x55: 1}
        - keys: {tenantId: 1, x56: 1}
        - keys: {tenantId: 1, x57: 1}
        - keys: {tenantId: 1, x58: 1}
        - keys: {tenantId: 1, x59: 1}
        - keys: {tenantId: 1, x60: 1}
        - keys: {tenantId: 1, x61: 1}
        - keys: {tenantId: 1, x62: 1}
        - keys: {tenantId: 1, x63: 1}

- Name: Quiesce
  Type: QuiesceActor
  Threads: 1
  Database: *db
  Phases:
    OnlyActiveInPhases:
      Active: [2]
      NopInPhasesUpTo: *maxPhase
      PhaseConfig:
        Repeat: 1

- Name: SimpleMultiplannerWith64Indexes
  LoadConfig:
    Path: "../../../phases/query/Multiplanner.yml"
    Key: QueryTemplate
    Parameters:
      active: [3]
      nopInPhasesUpTo: *maxPhase
      repeat: *queryRepeats
      database: *db
      collection: *coll
      query: &query {
        Filter: {
          tenantId: {$eq : 0},
          x1: {$lt: *selectivity},
          x2: {$lte: 1},
          x3: {$lte: 1}
        }
      }

- Name: Hide48Indexes
  Type: RunCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [4]
      NopInPhasesUpTo: *maxPhase
      PhaseConfig:
        Repeat: 1
        Database: *db
        Operations:
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x17: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x18: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x19: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x20: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x21: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x22: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x23: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x24: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x25: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x26: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x27: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x28: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x29: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x30: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x31: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x32: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x33: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x34: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x35: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x36: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x37: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x38: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x39: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x40: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x41: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x42: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x43: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x44: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x45: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x46: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x47: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x48: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x49: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x50: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x51: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x52: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x53: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x54: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x55: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x56: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x57: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x58: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x59: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x60: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x61: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x62: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x63: 1}}}}

- Name: SimpleMultiplannerWith16Indexes
  LoadConfig:
    Path: "../../../phases/query/Multiplanner.yml"
    Key: QueryTemplate
    Parameters:
      active: [5]
      nopInPhasesUpTo: *maxPhase
      repeat: *queryRepeats
      database: *db
      collection: *coll
      query: *query

- Name: Hide14Indexes
  Type: RunCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [6]
      NopInPhasesUpTo: *maxPhase
      PhaseConfig:
        Repeat: 1
        Database: *db
        Operations:
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x3: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x4: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x5: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x6: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x7: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x8: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x9: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x10: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x11: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x12: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x13: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x14: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x15: 1}}}}
        - {OperationName: RunCommand, OperationCommand: {collMod: *coll, index: {hidden: true, keyPattern: {tenantId: 1, x16: 1}}}}

- Name: SimpleMultiplannerWith2Indexes
  LoadConfig:
    Path: "../../../phases/query/Multiplanner.yml"
    Key: QueryTemplate
    Parameters:
      active: [7]
      nopInPhasesUpTo: *maxPhase
      repeat: *queryRepeats
      database: *db
      collection: *coll
      query: *query

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone-sbe
      - standalone-all-feature-flags  # At time of writing this will enable PM-3591.
      - standalone-classic-query-engine
    branch_name:
      $gte: v7.3