SchemaVersion: 2018-07-01
Owner: "@10gen/altas-streams"
Description: |
  Streaming pipeline that runs with a stateful window operator on the input data. This
  is meant to stress the window operator, which is a commonly used operator. This will
  only create a single key within every 10s window since its just looking for the max
  value across all events, so this is just testing the throughput for the window operator.

Keywords:
- streams

GlobalDefaults:
  DatabaseName: &DatabaseName "test"
  StreamProcessorName: &StreamProcessorName "sp"

  # Use 16 inserter threads that insert 100 batches of 1k documents, so
  # total of 1.6M documents.
  NumThreads: &NumThreads 16

Actors:
- Name: Setup
  Type: RunCommand
  ClientName: Stream
  Threads: 1
  Phases:
  - Phase: 0
    Repeat: 1
    Database: *DatabaseName
    Operations:
    - OperationMetricsName: CreateStreamProcessor
      OperationName: RunCommand
      OperationCommand:
        streams_startStreamProcessor: ""
        name: *StreamProcessorName
        pipeline: [
          {
            $source: {
              connectionName: "kafka",
              topic: "topic-input",
              timeField: { $convert: { input: "$dateTime", to: "date" }},
              allowedLateness: { size: 10, unit: "second" },
              testOnlyPartitionCount: 1
            }
          },
          {
            $tumblingWindow: {
              interval: { size: 10, unit: "second" },
              pipeline: [
                { 
                  $group: {
                    _id: null,
                    maxPrice: { $max: "$price" }
                  }
                }
              ]
            }
          },
          { $emit: { connectionName: "__testMemory" } }
        ]
        connections: [
          {
            name: "kafka",
            type: "kafka",
            options: {
              bootstrapServers: "localhost:9092",
              isTestKafka: true
            }
          },
          { name: "__testMemory", type: "in_memory", options: {} }
        ]
  - Phase: 1
    Nop: true
  - Phase: 2
    Repeat: 1
    Database: *DatabaseName
    Operations:
    - OperationMetricsName: Stop
      OperationName: RunCommand
      OperationCommand:
        streams_stopStreamProcessor: ""
        name: *StreamProcessorName

- Name: Insert_Batch100x
  Type: RunCommand
  ClientName: Stream
  Threads: *NumThreads
  Phases:
  - Phase: 0
    Nop: true
  - Phase: 1
    LoadConfig:
      Path: ./InsertBidsTemplate.yml
      Key: InsertBids
      Parameters:
        Database: *DatabaseName
        StreamProcessorName: *StreamProcessorName
  - Phase: 2
    Nop: true

- Name: Stats
  Type: StreamStatsReporter
  Database: *DatabaseName
  Threads: 1
  Phases:
  - Phase: 0
    Nop: true
  - Phase: 1
    Repeat: 1
    StreamProcessorName: *StreamProcessorName
    ExpectedDocumentCount: 1600000
  - Phase: 2
    Nop: true

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone-streams
    branch_name:
      $gte: v7.2
