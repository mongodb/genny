SchemaVersion: 2018-07-01
Owner: "@10gen/altas-streams"
Description: |
  Streaming pipeline that runs a very simple single stage projection pipeline. This
  is meant to represent the most barebone use case for streaming.

Keywords:
- streams

GlobalDefaults:
  DatabaseName: &DatabaseName "test"
  StreamProcessorName: &StreamProcessorName "sp"

Actors:
- Name: Setup
  Type: RunCommand
  ClientName: Stream
  Threads: 1
  Phases:
  - Phase: 0
    Repeat: 1
    Database: *DatabaseName
    Operations:
    - OperationMetricsName: CreateStreamProcessor
      OperationName: RunCommand
      OperationCommand:
        streams_startStreamProcessor: ""
        name: *StreamProcessorName
        pipeline: [
          { $source: { connectionName: "kafka", topic: "perf-input", config: { startAt: "earliest" }}},
          {
            $project: {
              auction: 1,
              bidder: 1,
              dateTime: 1,
              price: { $multiply: ["$price", 0.908] }
            }
          },
          { $emit: { connectionName: "__testMemory" } }
        ]
        connections: [
           { name: "__testMemory", type: "in_memory", options: {} },
           { name: "kafka", type: "kafka", options: { bootstrapServers: "10.2.0.10:27017" } }
        ]
  - Phase: 1
    Nop: true
  - Phase: 2
    Repeat: 1
    Database: *DatabaseName
    Operations:
    - OperationMetricsName: Stop
      OperationName: RunCommand
      OperationCommand:
        streams_stopStreamProcessor: ""
        name: *StreamProcessorName

- Name: Stats
  Type: StreamStatsReporter
  ClientName: Stream
  Database: *DatabaseName
  Threads: 1
  Phases:
  - Phase: 0
    Nop: true
  - Phase: 1
    Repeat: 1
    StreamProcessorName: *StreamProcessorName
    ExpectedDocumentCount: 1600000
  - Phase: 2
    Nop: true
