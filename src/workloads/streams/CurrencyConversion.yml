SchemaVersion: 2018-07-01
Owner: "@10gen/altas-streams"
Description: |
  Streaming pipeline that applies currency conversion from USD to EU.

GlobalDefaults:
  DatabaseName: &DatabaseName "test"
  StreamProcessorName: &StreamProcessorName "sp"

Actors:
- Name: Setup
  Type: RunCommand
  Threads: 1
  Phases:
  - Phase: 0
    Repeat: 1
    Database: *DatabaseName
    Operations:
    - OperationMetricsName: CreateStreamProcessor
      OperationName: RunCommand
      OperationCommand:
        streams_startStreamProcessor: ""
        name: *StreamProcessorName
        pipeline: [
          { $source: { connectionName: "__testMemory" } },
          { $project: {
              auction: 1,
              bidder: 1,
              dateTime: 1,
              price: { $multiply: ["$price", 0.908] }
          }},
          { $emit: { connectionName: "__testMemory" } }
        ]
        connections: []
  - Phase: 1..2
    Nop: true

- Name: Insert_Batch1000x
  Type: RunCommand
  Threads: 32
  Phases:
    - Phase: 0
      Nop: true
    - Phase: 1
      LoadConfig:
        Path: ./InsertBidsTemplate.yml
        Key: InsertBids
        Parameters:
          Database: *DatabaseName
          StreamProcessorName: *StreamProcessorName
    - Phase: 2
      Repeat: 1
      Database: *DatabaseName
      Operations:
      - OperationMetricsName: Stop
        OperationName: RunCommand
        OperationCommand:
          streams_stopStreamProcessor:
          name: *StreamProcessorName
