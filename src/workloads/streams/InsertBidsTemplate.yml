SchemaVersion: 2018-07-01
Owner: "@10gen/altas-streams"
Description: |
  Utility to insert random bids into a stream processor.

GlobalDefaults:
  DatabaseName: &DatabaseName test
  StreamProcessorName: &StreamProcessorName sp

  Channel: &Channel {^RandomInt: { min: 0, max: 10000 }}
  Urls: &Urls {^Cycle: { ofLength: 10000, fromGenerator: {^FormatString: { format: "https://www.nexmark.com/%s/%s/%s/item.htm?query=1&channel_id=%d", withArgs: [
    {^RandomString: { length: {^RandomInt: { min: 3, max: 5 }}}},
    {^RandomString: { length: {^RandomInt: { min: 3, max: 5 }}}},
    {^RandomString: { length: {^RandomInt: { min: 3, max: 5 }}}},
    *Channel
  ]}}}}

  Document: &Document
    auction: {^Inc: { start: 1000 }}
    bidder: {^Inc: { start: 1000 }}
    price: {^RandomDouble: {min: 100, max: 100000000}}
    channel: *Channel
    url: *Urls
    dateTime: {^IncDate: { start: "2023-01-01T00:00:00.000", step: 10 }}

  Batch10x: &Batch10x [*Document, *Document, *Document, *Document, *Document, *Document, *Document, *Document, *Document, *Document]
  Batch100x: &Batch100x {^FlattenOnce: [*Batch10x, *Batch10x, *Batch10x, *Batch10x, *Batch10x, *Batch10x, *Batch10x, *Batch10x, *Batch10x, *Batch10x]}
  Batch1000x: &Batch1000x {^FlattenOnce: [*Batch100x, *Batch100x, *Batch100x, *Batch100x, *Batch100x, *Batch100x, *Batch100x, *Batch100x, *Batch100x, *Batch100x]}

InsertBids:
  Repeat: {^Parameter: { Name: "Repeat", Default: 100 }}
  Database: {^Parameter: { Name: "Database", Default: *DatabaseName }}
  Operations:
  - OperationMetricsName: Insert
    OperationName: RunCommand
    OperationCommand:
      streams_testOnlyInsert: ""
      name: {^Parameter: { Name: "StreamProcessorName", Default: *StreamProcessorName }}
      documents: *Batch1000x
