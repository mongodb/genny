SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  This workload tests the performance of last point queries after the first milestone.
  More specifically this workload benchmarks the performance for $sort + $group cases
  including a compatible $match in front of $sort with the only index in the form of
  {meta.a: 1, ts: -1}.

Actors:
- Name: CreateTimeSeriesCollection
  Type: RunCommand
  Threads: 1
  Phases:
  - Repeat: 1
    Database: &db test
    Operation:
      OperationMetricsName: CreateTimeSeriesCollection
      OperationName: RunCommand
      OperationCommand:
        {create: &coll Collection0, timeseries: {timeField: "time", metaField: "tags"}}
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true

- Name: InsertData
  Type: Loader
  Threads: 1
  Phases:
  - Repeat: 1
    Database: *db
    Collection: *coll
    Threads: 1
    CollectionCount: 1
    DocumentCount: 500000
    BatchSize: &batchSize 100
    Document:
      time: {^RandomDate: {min: "2022-01-01", max: "2022-01-01T01:00:00.001"}}
      tags: {
        rack: {^RandomInt: {min: 0, max: 4}},
        team: {^Choose: {from: [
          "NYC", "CHI", "SF", "LON"]}},
        arch: {^Choose: {from: [
          "x64", "x86"]}},
        region: {^Choose: {from: [
          "us-east-1", "us-west-1", "us-west-2", "eu-west-1", "eu-central-1",
          "ap-southeast-1", "ap-southeast-2", "ap-northeast-1", "sa-east-1"]}}
      }
      usage_irq: {^RandomDouble: {min: 0, max: 62}}
      usage_softirq: {^RandomInt: {min: 0, max: 8}}
      usage_steal: {^RandomInt: {min: 0, max: 43}}
      usage_idle: {^RandomInt: {min: 0, max: 21}}
      usage_guest: {^RandomInt: {min: 0, max: 77}}
      usage_nice: {^RandomInt: {min: 0, max: 60}}
      usage_iowait: {^RandomInt: {min: 0, max: 21}}
      usage_system: {^RandomInt: {min: 0, max: 0}}
      usage_user: {^RandomInt: {min: 0, max: 66}}
      measurement: "cpu"
      usage_guest_nice: {^RandomInt: {min: 0, max: 31}}
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true

- Name: Quiesce
  Type: QuiesceActor
  Threads: 1
  Database: *db
  Phases:
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true

- Name: CreateIndex
  Type: RunCommand
  Threads: 1
  Phases:
  - Nop: true
  - Nop: true
  - Repeat: 1
    Database: *db
    Operations:
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *coll
        indexes: [{key: {tags.rack: 1, time: -1}, name: "x_1"}]
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true

- Name: Run
  Type: RunCommand
  Database: *db
  Phases:
  - Repeat: 10
    Database: *db
    Operations:
    - OperationMetricsName: RunSortGroupLastPointCommand
      OperationName: RunCommand
      OperationCommand:
        aggregate: *coll
        pipeline:
          [
            {$sort: {
              "tags.rack": 1,
              "time": -1,
            }},
            {$group: {
              _id: "$tags.rack",
              last: {
                $first: "$$ROOT"
              }}}
          ]
        cursor: {batchSize: *batchSize}
    - OperationMetricsName: RunMatchSortGroupLastPointCommandWithDistinctGroup1
      OperationName: RunCommand
      OperationCommand:
        aggregate: *coll
        pipeline:
          [
            {$match: {
              "tags.rack": 2,
            }},
            {$sort: {
              "tags.rack": 1,
              "time": -1,
            }},
            {$group: {
              _id: "$tags.rack",
              last: {
                $first: "$usage_irq",
              }}}
          ]
        cursor: {batchSize: *batchSize}
    - OperationMetricsName: RunMatchSortGroupLastPointCommandWithDistinctGroup2
      OperationName: RunCommand
      OperationCommand:
        aggregate: *coll
        pipeline:
          [
            {$match: {
              "tags.rack": 2,
            }},
            {$sort: {
              "tags.rack": 1,
              "time": -1,
            }},
            {$group: {
              _id: "$tags.rack",
              last: {
                $first: "$usage_softirq",
              }}}
          ]
        cursor: {batchSize: *batchSize}
    - OperationMetricsName: RunMatchSortGroupLastPointCommandWithDistinctGroup3
      OperationName: RunCommand
      OperationCommand:
        aggregate: *coll
        pipeline:
          [
            {$match: {
              "tags.rack": 2,
            }},
            {$sort: {
              "tags.rack": 1,
              "time": -1,
            }},
            {$group: {
              _id: "$tags.rack",
              last: {
                $first: "$usage_system",
              }}}
          ]
        cursor: {batchSize: *batchSize}
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true
  - Nop: true

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone
      - replica
      - replica-all-feature-flags
      - single-replica
    branch_name:
      $neq:
      - v4.0
      - v4.2
      - v4.4
      - v5.0
      - v5.1
      - v5.2
