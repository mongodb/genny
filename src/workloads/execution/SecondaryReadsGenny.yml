SchemaVersion: 2018-07-01
Owner: "@TODO"
Description: >
  TODO

Initial_nb_docs: &initial_nb_docs 10000
DocumentSize: &document_size 459 # Object.bsonsize({_id: ObjectId(), x: 0, str: "x"}) + 1 --> 41
InsertLimit: &insert_limit 100
TestDurationInSecs: &test_duration 10 seconds
Db: &db test
WriterThreads: &writer_threads 16
NumPhases: &max_phase 13

Clients:
  Secondary:
    URI: mongodb://md1:27017

ActorTemplates:
- TemplateName: LoadInitialDataTemplate
  Config:
    Name: {^Parameter: {Name: "Name", Default: LoadInitialData}}
    Type: Loader
    Threads: 1
    Phases:
      OnlyActiveInPhases:
        Active: {^Parameter: {Name: "ActivePhases", Default: [-1]}}
        NopInPhasesUpTo: *max_phase
        PhaseConfig:
          Repeat: 1
          Database: *db
          Threads: 1
          CollectionCount: 1
          DocumentCount: *initial_nb_docs
          BatchSize: *initial_nb_docs
          Document: 
            x: {^Inc: {}}
            #s: {^Repeat: {count: *document_size, fromGenerator: {^Choose: {from: ["x"]}}}} --> why does this not work?
            s: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
          Indexes:
          - keys: {x: 1}

- TemplateName: QuiesceTemplate
  Config:
    Name: {^Parameter: {Name: "Name", Default: Quiesce}}
    Type: QuiesceActor
    Threads: 1
    Database: *db
    Phases:
      OnlyActiveInPhases:
        Active: {^Parameter: {Name: "ActivePhases", Default: [-1]}}
        NopInPhasesUpTo: *max_phase
        PhaseConfig:
          Repeat: 1
            

- TemplateName: WritesOnPrimaryTemplate
  Config:
    Name: {^Parameter: {Name: "Name", Default: WritesOnPrimary}}
    Type: CrudActor
    Threads: *writer_threads
    Database: *db
    Phases:
      OnlyActiveInPhases:
        Active: {^Parameter: {Name: "ActivePhases", Default: [-1]}}
        NopInPhasesUpTo: *max_phase
        PhaseConfig:
          Duration: *test_duration
          Collection: Collection0
          Operations:
          - OperationName: insertOne
            OperationCommand:
              Document:
                x: {^RandomInt: {min: *initial_nb_docs, max: 1000000000}}
                #s: {^Repeat: {count: *document_size, fromGenerator: {^Choose: {from: ["x"]}}}} --> why does this not work?
                s: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


- TemplateName: ReadsOnSecondaryTemplate
  Config:
    Name: {^Parameter: {Name: "Name", Default: ReadsOnSecondary}}
    Type: CrudActor
    Threads: {^Parameter: {Name: "Threads", Default: -1}}
    ClientName: Secondary
    Database: *db
    Phases:
      OnlyActiveInPhases:
        Active: {^Parameter: {Name: "ActivePhases", Default: [-1]}}
        NopInPhasesUpTo: *max_phase
        PhaseConfig:
          Duration: *test_duration
          Collection: Collection0
          Operations:
          - OperationName: find
            OperationCommand:
              Filter: { x: {$gte: {^RandomInt: {min: 0, max: *initial_nb_docs}}}}
              Options:
                Limit: *insert_limit
                BatchSize: 200
                ReadPreference:
                  ReadMode: secondaryPreferred

- TemplateName: ReplicationLagTemplate
  Config:
    Name: {^Parameter: {Name: "Name", Default: ReplicationLag}}
    Type: CrudActor
    Threads: 1
    Database: *db
    Phases:
      OnlyActiveInPhases:
        Active: {^Parameter: {Name: "ActivePhases", Default: [-1]}}
        NopInPhasesUpTo: *max_phase
        PhaseConfig:
          Repeat: 1
          Collection: Collection0
          Operations:
          - OperationName: insertOne
            OperationCommand:
              Document: {s: 1}
              OperationOptions:
                WriteConcern:
                  Level: 3
                  Journal: true

- TemplateName: CleanUpTemplate
  Config:
    Name: {^Parameter: {Name: "Name", Default: CleanUp}}
    Type: RunCommand
    Threads: 1
    Phases:
      OnlyActiveInPhases:
        Active: {^Parameter: {Name: "ActivePhases", Default: [-1]}}
        NopInPhasesUpTo: *max_phase
        PhaseConfig:
          Repeat: 1
          Database: *db
          Operations:
          - OperationName: RunCommand
            OperationCommand:
              drop: Collection0

Actors:
- ActorFromTemplate:
    TemplateName: LoadInitialDataTemplate
    TemplateParameters:
      Name: LoadInitialData
      ActivePhases: [0, 5, 10]

- ActorFromTemplate:
    TemplateName: QuiesceTemplate
    TemplateParameters:
      Name: Quiesce
      ActivePhases: [1, 6, 11]

- ActorFromTemplate:
    TemplateName: CleanUpTemplate
    TemplateParameters:
      Name: CleanUp
      ActivePhases: [4, 9]

- ActorFromTemplate:
    TemplateName: WritesOnPrimaryTemplate
    TemplateParameters:
      Name: 1T-WritesOnPrimary
      ActivePhases: [2]

- ActorFromTemplate:
    TemplateName: WritesOnPrimaryTemplate
    TemplateParameters:
      Name: 16T-WritesOnPrimary
      ActivePhases: [7]

- ActorFromTemplate:
    TemplateName: WritesOnPrimaryTemplate
    TemplateParameters:
      Name: 32T-WritesOnPrimary
      ActivePhases: [12]

- ActorFromTemplate:
    TemplateName: ReadsOnSecondaryTemplate
    TemplateParameters:
      Name: 1T-ReadsOnSecondary
      ActivePhases: [2]
      Threads: 1

- ActorFromTemplate:
    TemplateName: ReadsOnSecondaryTemplate
    TemplateParameters:
      Name: 16T-ReadsOnSecondary
      ActivePhases: [7]
      Threads: 16

- ActorFromTemplate:
    TemplateName: ReadsOnSecondaryTemplate
    TemplateParameters:
      Name: 32T-ReadsOnSecondary
      ActivePhases: [12]
      Threads: 32

- ActorFromTemplate:
    TemplateName: ReplicationLagTemplate
    TemplateParameters:
      Name: 1T-ReplicationLag
      ActivePhases: [3]

- ActorFromTemplate:
    TemplateName: ReplicationLagTemplate
    TemplateParameters:
      Name: 16T-ReplicationLag
      ActivePhases: [8]

- ActorFromTemplate:
    TemplateName: ReplicationLagTemplate
    TemplateParameters:
      Name: 36T-ReplicationLag
      ActivePhases: [13]


AutoRun:
- When:
    mongodb_setup:
      $eq:
      - replica
      #- replica-last-continuous-fcv
      #- replica-last-lts-fcv
      - replica-all-feature-flags
      - atlas-like-replica
    branch_name:
      $neq:
      - v4.0
