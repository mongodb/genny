SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: >
  Check performance of a project followed by a sort that can be swapped in order to push down. Check the
  performance both without and without an index.
  Important Metrics: timers.dur, timers.total on the aggregate commands. The index build is to test the performance
  of the aggregation with/without an index.
Keywords:
  indexes
  collections
  aggregation
  sort

GlobalDefaults:
  aggregate: &collName Collection0
  exclusionPpipeline: &exclusionPipe [{$project: {array: 0}}, {$sort: {integer: 1}}]
  inclusionPipeline: &inclusionPipe [{$project: {integer: 1, double: 1}}, {$sort: {integer: 1}}]

Actors:
- Name: InsertData
  Type: Loader
  Threads: 1
  Phases:
  - Repeat: 1
    Database: &db test
    Threads: 1
    CollectionCount: 1
    DocumentCount: &docCount 100000
    BatchSize: *docCount
    Document:
      integer: &integer {^RandomInt: {min: 1, max: 10000}}
      double: &double {^RandomInt: {distribution: geometric, p: 0.1}}
      string: &string {^RandomString: {length: 16}}
      array:
      - *integer
      - *integer
      - subInteger: *integer
        subString: *string
        subArray:
        - *integer
        - *integer
      - subInteger: *integer
        subString: *string
        subArray:
        - *integer
        - *integer
  - &Nop {Nop: true}
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

- Name: BuildIndex
  Type: RunCommand
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - Repeat: 1
    Database: *db
    Operations:
    - OperationName: RunCommand
      OperationCommand:
        createIndexes: *collName
        indexes: &IndexSpec [{key: {"integer": 1}, name: "int_1"}]
  - *Nop
  - *Nop
  - *Nop
  - *Nop


- Name: Quiesce
  Type: QuiesceActor
  Threads: 1
  Database: *db
  Phases:
  - *Nop
  - Repeat: 1
  - *Nop
  - Repeat: 1
  - *Nop
  - Repeat: 1
  - *Nop
  - Repeat: 1
  - *Nop
  - Repeat: 1
  - *Nop

- Name: AggregateNoIndexExclusion
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - Repeat: &aggRepeat 10
    Database: *db
    Operations:
    - OperationMetricsName: AggregateNoIndex
      OperationName: RunCommand
      OperationCommand:
        aggregate: *collName
        pipeline: *exclusionPipe
        cursor: {batchSize: *docCount}
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

- Name: AggregateNoIndexInclusion
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - Repeat: *aggRepeat
    Database: *db
    Operations:
    - OperationMetricsName: AggregateNoIndex
      OperationName: RunCommand
      OperationCommand:
        aggregate: *collName
        pipeline: *inclusionPipe
        cursor: {batchSize: *docCount}
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

- Name: AggregateIndexExclusion
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - Repeat: *aggRepeat
    Database: *db
    Operations:
    - OperationMetricsName: AggregateIndex
      OperationName: RunCommand
      OperationCommand:
        aggregate: *collName
        pipeline: *exclusionPipe
        cursor: {batchSize: *docCount}
  - *Nop
  - *Nop

- Name: AggregateIndexInclusion
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - Repeat: *aggRepeat
    Database: *db
    Operations:
    - OperationMetricsName: AggregateIndex
      OperationName: RunCommand
      OperationCommand:
        aggregate: *collName
        pipeline: *inclusionPipe
        cursor: {batchSize: *docCount}

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone
      - standalone-classic-query-engine
    branch_name:
      $neq:
      - v4.0
      - v4.2
      - v4.4
      - v5.0
