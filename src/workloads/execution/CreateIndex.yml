SchemaVersion: 2018-07-01
Owner: "@mongodb/server-execution"
Description: |
  This workload tests the performance of index creation on replica sets, standalones, and sharded clusters. We use
  2 main actors, InsertData and IndexCollection. For more information about these actors, please refer to CreateIndexPhase.yml.
  Additionally, in sharded instances only, the EnableSharding and ShardCollection actors are used. Note that this test was
  originally two separate files, CreateIndex.yml and CreateIndexSharded.yml, but was merged into one as part of PERF-4347.

Keywords:
- indexes
- sharding

Actors:
- Name: EnableSharding
  Type: AdminCommand
  Threads: 1
  Phases:
  - Repeat: 1
    Database: admin
    # Until EVG-21054 is resolved, using OnlyRunInInstance requires excluding the workload from dry-runs
    OnlyRunInInstance: sharded
    Operations:
    - OperationMetricsName: EnableSharding
      OperationName: AdminCommand
      OperationCommand:
        enableSharding: &db test
  - &Nop {Nop: true}
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

- Name: ShardCollection
  Type: AdminCommand
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 1
    Database: admin
    OnlyRunInInstance: sharded
    Operations:
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0  # Collection0 is the default collection populated by the Loader.
        key:
          _id: hashed
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

- Name: InsertData
  Type: Loader
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - LoadConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: InsertData
      Parameters:
        db: *db
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

- Name: IndexCollection
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - LoadConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: Create2dIndexesCmd
      Parameters:
        Duration: 3 minutes
  - LoadConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: Create2dSphereIndexesCoordCmd
      Parameters:
        Duration: 3 minutes
  - LoadConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: Create2dSphereGeoJsonIndexesCmd
      Parameters:
        Duration: 3 minutes
  - LoadConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: CreateHashedIndexesCmd
      Parameters:
        Duration: 3 minutes
  - LoadConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: CreateTextIndexesCmd
      Parameters:
        Duration: 3 minutes
  - # For an already-sharded collection, you cannot create unique indexes on other fields.
    #Â https://www.mongodb.com/docs/manual/core/sharding-shard-key/#unique-indexes
    OnlyRunInInstances: [standalone, replica_set]
    LoadConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: CreateUniqueIndexesCmd
      Parameters:
        Duration: 3 minutes
  - LoadConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: CreateWildCardIndexesCmd
      Parameters:
        Duration: 3 minutes

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - atlas
      - atlas-like-replica.2022-10
      - replica
      - single-replica
      - standalone
      - shard
      - shard-lite
    atlas_setup:
      $neq:
      - M30-repl
    branch_name:
      $neq:
      - v4.0
