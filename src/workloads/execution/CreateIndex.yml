SchemaVersion: 2018-07-01
Owner: "@mongodb/server-execution"
# TODO Update description
Description: |
   This workload tests the performance of index creation on replica sets and standalones. We use
   2 actors, InsertData and IndexCollection. For more information about these actors, please refer
   to CreateIndexPhase.yml.

# TODO Copied over from CreateIndexSharded.yml
Keywords:
- sharding
- indexes

Actors:
- Name: EnableSharding
  Type: AdminCommand
  Threads: 1
  Phases:
  - Repeat: 1
    Database: admin
    # Until TIG-3290 is resolved, using OnlyRunInInstance requires excluding the workload from dry-runs
    # TODO Find TIG-3290
    OnlyRunInInstance: sharded
    Operations:
    - OperationMetricsName: EnableSharding
      OperationName: AdminCommand
      OperationCommand:
        enableSharding: &db test
  - &Nop {Nop: true}
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

- Name: ShardCollection
  Type: AdminCommand
  Threads: 1
  Phases:
  - *Nop
  - Repeat: 1
    Database: admin
    OnlyRunInInstance: sharded
    Operations:
    - OperationMetricsName: ShardCollection
      OperationName: AdminCommand
      OperationCommand:
        shardCollection: test.Collection0  # Collection0 is the default collection populated by the Loader.
        key:
          _id: hashed
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

- Name: InsertData
  Type: Loader
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - LoadConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: InsertData
      Parameters:
        db: *db
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop
  - *Nop

# TODO Change Repeat/Duration param 
- Name: IndexCollection
  Type: RunCommand
  Threads: 1
  Phases:
  - *Nop
  - *Nop
  - *Nop
  - LoadConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: Create2dIndexesCmd
      Parameters:
        Repeat: 1
  - LoadConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: Create2dSphereIndexesCoordCmd
      Parameters:
        Repeat: 1
  - LoadConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: Create2dSphereGeoJsonIndexesCmd
      Parameters:
        Repeat: 1
  - LoadConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: CreateHashedIndexesCmd
      Parameters:
        Repeat: 1
  - LoadConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: CreateTextIndexesCmd
      Parameters:
        Repeat: 1
  - LoadConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: CreateUniqueIndexesCmd
      Parameters:
        Repeat: 1
    # For an already-sharded collection, you cannot create unique indexes on other fields.
    # https://www.mongodb.com/docs/manual/core/sharding-shard-key/#unique-indexes
    OnlyRunInInstances: [standalone, replica_set]
  - LoadConfig:
      Path: ../../phases/execution/CreateIndexPhase.yml
      Key: CreateWildCardIndexesCmd
      Parameters:
        Repeat: 1

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - atlas
      - atlas-like-replica.2022-10
      - replica
      - single-replica
      - standalone
      - shard
      - shard-lite
    atlas_setup:
      $neq:
      - M30-repl
    branch_name:
      $neq:
      - v4.0
