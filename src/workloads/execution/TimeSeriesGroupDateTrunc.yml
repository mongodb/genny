SchemaVersion: 2018-07-01
Owner: "@mongodb/query-execution"
Description: |
  This workload tests time-seires $group query with $dateTrunc expression as group id. There're following phases:
  1. Clean and setup the collection.
  2. Load the data, the shape of data can be controlled by meta_count and document_count.
  3. Run the $group aggregation, the test repetition can be controlled by test_repeat.

Keywords:
- timeseries
- aggregate
- group

Database: &db timeseries
Collection: &coll Collection0

TimeField: &time time
MetaField: &meta meta
ValueField: &value value
DollarTimeField: &dollar_t {^Join: {array: [$, *time]}}
DollarMetaField: &dollar_m {^Join: {array: [$, *meta]}}
DollarValueField: &dollar_value {^Join: {array: [$, *value]}}

MetaCount: &meta_count 10
DocumentCount: &document_count 1000000
TestRepeat: &test_repeat 10

Actors:
- Name: Setup
  Type: RunCommand
  Thread: 1
  Phases:
  - Repeat: 1
    Database: *db
    Operations:
    # The dropDatabase command is used to facilitate local testing.
    - OperationName: RunCommand
      OperationCommand: {dropDatabase: 1}
    - OperationName: RunCommand
      OperationCommand: {create: *coll, timeseries: {timeField: *time, metaField: *meta}}
  - &nop {Nop: true}
  - *nop

- Name: Load
  Type: Loader
  Threads: 1
  Phases:
  - *nop
  - Repeat: 1
    Threads: 1
    Database: *db
    CollectionCount: 1
    DocumentCount: *document_count
    BatchSize: 1000
    Document:
      *time:
        ^IncDate:
          start: 2022-01-01
          # 100ms step ensures full bucket of 1000 documents under the default 'seconds' granularity.
          step: 100
      *meta:
        ^Cycle:
          ofLength: *meta_count
          fromGenerator:
            ^RandomString:
              length: 6
              alphabet: "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
      *value:
        ^RandomDouble:
          min: 0.0
          max: 100.0
  - *nop

- Name: Aggregate
  Type: RunCommand
  Phases:
  - *nop
  - *nop
  - Repeat: *test_repeat
    Database: *db
    Operations:
    - OperationName: RunCommand
      OperationCommand:
        aggregate: *coll
        pipeline:
          [
            $group: {
              _id: {
                meta: *dollar_m,
                time: {
                  $dateTrunc: {
                    date: *dollar_t,
                    unit: 'month',
                  }
                }
              },
              max: { $max: *dollar_value },
              min: { $min: *dollar_value },
              first: { $first: *dollar_value },
              last: { $last: *dollar_value },
            }
          ]
        cursor:
          batchSize: 1000

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone
      - standalone-all-feature-flags
      - replica
      - replica-all-feature-flags
    branch_name:
      $neq:
      - v4.0
      - v4.2
      - v4.4
      - v5.0
      - v5.1
      - v5.2
      - v5.3
