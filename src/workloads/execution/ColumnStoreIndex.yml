SchemaVersion: 2018-07-01
Owner: "@mongodb/query-execution"
Description: |
  This workload compares the query performance with columnar indexes to performances without them.

  The workload consists of the following phases and actors:
    0. Warm up cache.
    1. Run queries with columnstore indexes.
    2. Drop columnstore indexes.
    3. Warm up cache again for regular scans.
    4. Run queries without columnstore indexes.

Keywords:
- columnstore
- analytics
- scale

Clients:
  Default:
    QueryOptions:
      # Allow for longer duration since column store index build may take a while.
      socketTimeoutMS: 3_600_000  # = 1 hour
      connectTimeoutMS: 3_600_000

GlobalDefaults:
  # Defines the database name.
  Database: &db staging-bestbuy

  # Defines the collection name.
  Collection: &Collection products

  # Defines how many times each test operation is executed.
  TestRepeatCount: &TestRepeatCount 1

  # Loader Config.
  LoadThreads: &LoadThreads 4
  LoadBatchSize: &LoadBatchSize 100

  SingletonInsertDocCount: &SingletonInsertDocCount 40
  BulkLoadDocCount: &BulkLoadDocCount 400

  SetupPhase: &SetupPhase 0
  SingletonInsertsNoIndexPhase: &SingletonInsertsNoIndexPhase 1
  BulkLoadNoIndexPhase: &BulkLoadNoIndexPhase 2
  BuildColumnStoreIndexPhase: &BuildColumnStoreIndexPhase 3
  SingletonInsertsYesIndexPhase: &SingletonInsertsYesIndexPhase 4
  BulkLoadYesIndexPhase: &BulkLoadYesIndexPhase 5
  MaxPhases: &MaxPhases 6

  ColumnStoreIndexSpec: &ColumnStoreIndexSpec
    key: {$**: "columnstore"}
    name: "columnstore"
  
  Doc: &Doc
    sku: {^Inc: {}}
    description: "This is just a template document"

Actors:
- Name: Setup
  Type: AdminCommand
  Phases:
    OnlyActiveInPhases:
      Active: [*SetupPhase]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: admin
        Operations:
        - OperationName: AdminCommand
          OperationCommand:
            setParameter: 1
            internalQueryFrameworkControl: "trySbeEngine"

- Name: BulkLoadNoIndex
  Type: MonotonicSingleLoader
  Phases:
    OnlyActiveInPhases:
      Active: [*BulkLoadNoIndexPhase]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Threads: *LoadThreads
        Collection: *Collection
        Database: *db
        Repeat: 1
        Document: *Doc
        DocumentCount: *BulkLoadDocCount
        BatchSize: *LoadBatchSize

- Name: BuildColumnStoreIndex
  Type: RunCommand
  Phases:
    OnlyActiveInPhases:
      Active: [*BuildColumnStoreIndexPhase]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: *db
        Operations:
        - OperationMetricsName: BuildColumnStoreIndex
          OperationName: RunCommand
          OperationCommand:
            createIndexes: *Collection
            indexes:
              - *ColumnStoreIndexSpec

- Name: BulkLoadYesIndex
  Type: SamplingLoader
  Threads: *LoadThreads
  Phases:
    OnlyActiveInPhases:
      Active: [*BulkLoadYesIndexPhase]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Database: *db
        Collection: *Collection
        Repeat: 1
        Batches: 1
        InsertBatchSize: *LoadBatchSize

# TODO PERF-3094: Revive 'AutoRun' configuration when the project is near to a closure.
# AutoRun:
# - When:
#     mongodb_setup:
#       $eq:
#       - standalone-all-feature-flags
#     branch_name:
#       $neq:
#       - v4.0
#       - v4.2
#       - v4.4
#       - v5.0
#       - v5.3
#       - v6.0
#     ThenRun:
#     - test_control: charts_events_1G
