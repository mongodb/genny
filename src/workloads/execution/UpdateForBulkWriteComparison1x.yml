# VKTODO fill in everything correctly.
SchemaVersion: 2018-07-01
Owner: "@mongodb/replication"
Description: |
  Run updateOnes, deleteOnes, and findAndModifys on a replica set.

GlobalDefaults:
  Nop: &Nop {Nop: true}
  Database: &Database test
  WriteOp: &WriteOp { q: {key: 1}, u: {$inc: {a: 1}} }
  WriteOps1x: &WriteOps1x [
      *WriteOp
    ]
  WriteOps10x: &WriteOps10x {
      ^FlattenOnce:
        [
          *WriteOps1x, *WriteOps1x, *WriteOps1x, *WriteOps1x, *WriteOps1x,
          *WriteOps1x, *WriteOps1x, *WriteOps1x, *WriteOps1x, *WriteOps1x,
        ],
    }
  WriteOps100x: &WriteOps100x {
      ^FlattenOnce:
        [
          *WriteOps10x, *WriteOps10x, *WriteOps10x, *WriteOps10x, *WriteOps10x,
          *WriteOps10x, *WriteOps10x, *WriteOps10x, *WriteOps10x, *WriteOps10x,
        ],
    }
  WriteOps1000x: &WriteOps1000x {
      ^FlattenOnce:
        [
          *WriteOps100x, *WriteOps100x, *WriteOps100x, *WriteOps100x, *WriteOps100x,
          *WriteOps100x, *WriteOps100x, *WriteOps100x, *WriteOps100x, *WriteOps100x,
        ],
    }

Actors:
# Insert one document for the update to operate on repeatedly.
- Name: InsertOneDoc
  Type: RunCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: 2
      PhaseConfig:
        Repeat: 1
        Database: *Database
        Operations:
        - OperationName: RunCommand
          OperationMetricsName: InsertOneDocIgnore
          OperationCommand:
            insert: "bangalore"
            documents: [{key: 1, a: 0}]
            ordered: true
- Name: Updater
  Type: RunCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: 2
      PhaseConfig:
        # One million updates: 1000000 * 1
        Repeat: 1000000
        Database: *Database
        Operations:
        - OperationName: RunCommand
          OperationMetricsName: UpdateRoundTrip
          OperationCommand:
            update: "bangalore"
            updates: *WriteOps1x
            ordered: true

# Clients:
#   Default:
#     URI: "mongodb://localhost:20000"

# VKTODO
AutoRun:
- When:
    mongodb_setup:
      $eq:
      - single-replica-all-feature-flags
