SchemaVersion: 2018-07-01
Owner: "@mongodb/query-execution"
Description: |
  This workload measures bulk insert performance with the BestBuy dataset used in some other
  workloads. It's main purpose is to compare the insert performance with columnar indexes to inserts
  without them. To get a better illustration, it measures insert performance in three scenarios:
   - No indexes present
   - "Default" indexes present - a set of indexes that are typically present on the Best Buy dataset,
     those that would be useful for the typical query workloads.
   - Only a column store index. A column store index isn't expected to realistically replace all of
     those indexes in production, but it could replace some and knowing it's relative performance
     cost could help make that decision.

  In order to run this workload, the bestbuy dataset must be present already in the database under
  test. This is designed to test insert performance in more of a steady-state and hopefully I/O
  bound mongod.

  The workload consists of the following phases and actors:
   - Bulk inserting without any indexes. (SamplingLoader used to generate artificial inserts)
   - Build the indexes we typically see with Best Buy. (RunCommand Actor)
   - Measure bulk inserting again (SamplingLoader)
   - Drop all non-_id indexes (RunCommand Actor)
   - Build the column store index (RunCommand Actor)
   - Measure bulk inserting again (SamplingLoader)

Keywords:
- columnstore
- analytics
- scale
- insert

Clients:
  Default:
    QueryOptions:
      # Allow for longer duration since index builds may take a while.
      socketTimeoutMS: 3_600_000  # = 1 hour
      connectTimeoutMS: 3_600_000

GlobalDefaults:
  # Defines the database name.
  Database: &db bestbuy

  # Defines the collection name.
  Collection: &Collection products

  ColumnStoreIndexSpec: &ColumnStoreIndexSpec
    key: {$**: "columnstore"}
    name: "columnstore"

  LoadThreads: &LoadThreads 8

  SamplingLoaderPhaseConfig: &SamplingLoaderPhaseConfig
    Collection: *Collection
    Database: *db
    Repeat: 1
    InsertBatchSize: 400
    Batches: 20  # Per Thread
    SampleSize: 4000

Actors:
- Name: NoIndexes
  Type: SamplingLoader
  Threads: *LoadThreads
  Phases:
  - *SamplingLoaderPhaseConfig
  - {Nop: true}
  - {Nop: true}
  - {Nop: true}
  - {Nop: true}
  - {Nop: true}

- Name: BuildBestBuyIndexes
  Type: RunCommand
  Phases:
  - {Nop: true}
  - Repeat: 1
    Database: *db
    Operations:
    - OperationMetricsName: BuildBestBuyIndexes
      OperationName: RunCommand
      OperationCommand:
        createIndexes: *Collection
        indexes:
        - key:
            categoryPath.name : 1
          name: "categoryPath.name_1"
        - key:
            type: 1
            genre: 1
          name: "type_1_genre_1"
          partialFilterExpression: {type: "Music"}
        - key:
            type: 1
            "mpaaRating" : 1
            "format" : 1
            "genre" : 1
            "theatricalReleaseDate" : 1
          name: "type_1_mpaaRating_1_format_1_genre_1_theatricalReleaseDate_1"
          "partialFilterExpression" : {type: "Movie"}
        - key:
            type: 1
            "customerReviewCount" : -1
          name: "type_1_customerReviewCount_-1"
        - key:
            type: 1
            name: 1
          name: "type_1_name_1"
        - key:
            angleImage: 1
          name: "angleImage_1"
          "partialFilterExpression" : { "angleImage" : { "$type" : 2 } }
        - key:
            type: 1
            subclass : 1
            genre : 1
            format : 1
          name: "type_1_subclass_1_genre_1_format_1"
  - {Nop: true}
  - {Nop: true}
  - {Nop: true}
  - {Nop: true}

- Name: BaselineBestBuyIndexes
  Type: SamplingLoader
  Threads: *LoadThreads
  Phases:
  - {Nop: true}
  - {Nop: true}
  - *SamplingLoaderPhaseConfig
  - {Nop: true}
  - {Nop: true}
  - {Nop: true}

- Name: DropBaselineIndexes
  Type: RunCommand
  Phases:
  - {Nop: true}
  - {Nop: true}
  - {Nop: true}
  - Repeat: 1
    Database: *db
    Operations:
    - OperationMetricsName: DropBaselineIndexes
      OperationName: RunCommand
      OperationCommand:
        dropIndexes: *Collection
        index: "*"
  - {Nop: true}
  - {Nop: true}

- Name: BuildColumnStoreIndex
  Type: RunCommand
  Phases:
  - {Nop: true}
  - {Nop: true}
  - {Nop: true}
  - {Nop: true}
  - Repeat: 1
    Database: *db
    Operations:
    - OperationMetricsName: BuildColumnStoreIndex
      OperationName: RunCommand
      OperationCommand:
        createIndexes: *Collection
        indexes:
          - *ColumnStoreIndexSpec
  - {Nop: true}

- Name: ColumnStoreIndex
  Type: SamplingLoader
  Threads: *LoadThreads
  Phases:
  - {Nop: true}
  - {Nop: true}
  - {Nop: true}
  - {Nop: true}
  - {Nop: true}
  - *SamplingLoaderPhaseConfig

# TODO PERF-3094: Revive 'AutoRun' configuration when the project is near to a closure.
# AutoRun:
# - When:
#     mongodb_setup:
#       $eq:
#       - standalone-all-feature-flags
#     branch_name:
#       $neq:
#       - v4.0
#       - v4.2
#       - v4.4
#       - v5.0
#       - v5.3
#       - v6.0
#     ThenRun:
#     - test_control: bestbuy_inserts
