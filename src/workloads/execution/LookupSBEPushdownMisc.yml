SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  This workload conducts testing for the following test matrix:
  - LocalCollectionCardinality: 100k / 300k / 500k / 700k
  - DocumentSize: Small document size vs Large document size
  - JoinFieldType: string type / sub-field type / array type
  - NumberOfLookups: 1 / 2 / 3

  But this workload does not try to measure performances for full combination of the above test
  dimensions to avoid too lengthy test execution.

  While measuring performances, this workload collects numbers for both the SBE HJ and the classic
  engine NLJ $lookup implementations. The reason why it collects numbers for the SBE HJ lookup
  implementation is to minimize the test execution time since the SBE HJ is supposed to be very fast
  compared to the classic engine's NLJ.

  This workload assumes that the SBE and SBE $lookup pushdown features are turned on.

  The workload consists of the following phases and actors:
    0. Cleans up database
       - 'Setup' actor
    1. Loads data into the local and foreign collections.
       - 'LoadXXX' actors.
    2. Runs and measures the SBE HJ lookups.
       - 'SBE_Misc' actor
    3. Turns off the SBE
       - 'TurnOffSBE' actor
    4. Runs and measures the classic NLJ lookups
       - 'Classic_Misc' actor

# Defines the database name.
Database: &db lookup_sbe_pushdown_misc

# Defines foreign collection names.
Foreign: &Foreign foreign

# Defines the local collection names.
LocalSmallDoc100k: &LocalSmallDoc100k local_smalldoc_100k
LocalSmallDoc300k: &LocalSmallDoc300k local_smalldoc_300k
LocalSmallDoc500k: &LocalSmallDoc500k local_smalldoc_500k
LocalSmallDoc700k: &LocalSmallDoc700k local_smalldoc_700k
LocalLargeDoc100k: &LocalLargeDoc100k local_largedoc_100k

# Defines the small local collection document type which is used by 'LoadLocalSmallDocXXX' actors.
# See 'LocalSmallDocTemplate' to understand how each doc is filled.
LocalSmallDoc: &LocalSmallDoc
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalSmallDocTemplate
    Parameters: {card: 1500}

# Defines the large local collection document type which is used by 'LoadLocalLargeDoc100k' actor.
# See 'LocalLargeDocTemplate' to understand how each doc is filled.
LocalLargeDoc: &LocalLargeDoc
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: LocalLargeDocTemplate
    Parameters: {card: 1500}

# Defines the foreign collection document type which is used by 'LoadForeign' See
# 'ForeignSmallDocTemplate' to understand how each doc is filled.
ForeignSmallDoc: &ForeignSmallDoc
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: ForeignSmallDocTemplate
    Parameters: {card: 1500}

# The lookup command for local_smalldoc_100k.str_key == foreign.str_key.
HJLookupOnStrKeyCmd: &HJLookupOnStrKeyCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: HJLookupCmdTemplate
    Parameters:
      l: *LocalSmallDoc100k
      f: *Foreign
      lk: "str_key"
      k: "str_key"

# The lookup command for local_smalldoc_100k.int_key == foreign.arr_key.
HJLookupOnArrKeyCmd: &HJLookupOnArrKeyCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: HJLookupCmdTemplate
    Parameters:
      l: *LocalSmallDoc100k
      f: *Foreign
      k: "arr_key"

# The lookup command for local_smalldoc_100k.int_key == foreign.doc_key.int.
HJLookupOnSubFieldKeyCmd: &HJLookupOnSubFieldKeyCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: HJLookupCmdTemplate
    Parameters:
      l: *LocalSmallDoc100k
      f: *Foreign
      k: "doc_key.int"

# The lookup command for local_largedoc_100k.int_key == foreign.int_key.
HJLookupLargeDocCmd: &HJLookupLargeDocCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: HJLookupCmdTemplate
    Parameters:
      l: *LocalLargeDoc100k
      f: *Foreign

# The lookup command for local_smalldoc_300k.int_key == foreign.int_key.
HJLookupLocal100kCmd: &HJLookupLocal100kCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: HJLookupCmdTemplate
    Parameters:
      l: *LocalSmallDoc100k
      f: *Foreign

# The lookup command for local_smalldoc_300k.int_key == foreign.int_key.
HJLookupLocal300kCmd: &HJLookupLocal300kCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: HJLookupCmdTemplate
    Parameters:
      l: *LocalSmallDoc300k
      f: *Foreign

# The lookup command for local_smalldoc_500k.int_key == foreign.int_key.
HJLookupLocal500kCmd: &HJLookupLocal500kCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: HJLookupCmdTemplate
    Parameters:
      l: *LocalSmallDoc500k
      f: *Foreign

# The lookup command for local_smalldoc_700k.int_key == foreign.int_key.
HJLookupLocal700kCmd: &HJLookupLocal700kCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: HJLookupCmdTemplate
    Parameters:
      l: *LocalSmallDoc700k
      f: *Foreign

# The lookup command for local_smalldoc_100k.int_key == foreign.int_key
# | local_smalldoc_100k.str_key == foreign.str_key.
HJDoubleLookupCmd: &HJDoubleLookupCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: HJDoubleLookupCmdTemplate
    Parameters:
      l: *LocalSmallDoc100k

# The lookup command for local_smalldoc_100k.int_key == foreign.int_key
# | local_smalldoc_100k.str_key == foreign.str_key
# | local_smalldoc_100k.int_key == foreign.arr_key.
HJTripleLookupCmd: &HJTripleLookupCmd
  LoadConfig:
    Path: "../../phases/execution/LookupCommands.yml"
    Key: HJTripleLookupCmdTemplate
    Parameters:
      l: *LocalSmallDoc100k

# Defines test operations for both 'SBE_Misc' and 'Classic_Misc' actors.
TestOperations: &TestOperations
- OperationMetricsName: LocalSmallDoc100k_StrTopField
  OperationName: RunCommand
  OperationCommand: *HJLookupOnStrKeyCmd
- OperationMetricsName: LocalSmallDoc100k_ArrTopField
  OperationName: RunCommand
  OperationCommand: *HJLookupOnArrKeyCmd
- OperationMetricsName: LocalSmallDoc100k_SubField
  OperationName: RunCommand
  OperationCommand: *HJLookupOnSubFieldKeyCmd
- OperationMetricsName: LocalLargeDoc100k_IntTopField
  OperationName: RunCommand
  OperationCommand: *HJLookupLargeDocCmd
- OperationMetricsName: LocalSmallDoc100k_IntTopField
  OperationName: RunCommand
  OperationCommand: *HJLookupLocal100kCmd
- OperationMetricsName: LocalSmallDoc300k_IntTopField
  OperationName: RunCommand
  OperationCommand: *HJLookupLocal300kCmd
- OperationMetricsName: LocalSmallDoc500k_IntTopField
  OperationName: RunCommand
  OperationCommand: *HJLookupLocal500kCmd
- OperationMetricsName: LocalSmallDoc700k_IntTopField
  OperationName: RunCommand
  OperationCommand: *HJLookupLocal700kCmd
- OperationMetricsName: LocalSmallDoc100k_DoubleLookups
  OperationName: RunCommand
  OperationCommand: *HJDoubleLookupCmd
- OperationMetricsName: LocalSmallDoc100k_TripleLookups
  OperationName: RunCommand
  OperationCommand: *HJTripleLookupCmd

# Defines how many times each test operation is executed.
TestRepeatCount: &TestRepeatCount 10

Actors:
# The 'Setup' actor drops the database and runs in the 0th phase.
- Name: Setup
  Type: RunCommand
  Database: *db
  Thread: 1
  Phases:
  - Repeat: 1
    Threads: 1
    Database: *db
    Operations:
    - OperationName: RunCommand
      OperationCommand: {dropDatabase: 1}
  - Phase: 1..4
    Nop: true

# The 'LoadForeign' / 'LoadLocalSmallDoc100k' / 'LocalSmallDoc300k' / 'LocalSmallDoc500k' /
# 'LocalSmallDoc700k' / 'LoadLocalLargeDoc100k' actors runs in the 1st phase.
- Name: LoadForeign
  Type: CrudActor
  Database: *db
  Threads: 1
  Phases:
  - &Nop {Nop: true}
  - Repeat: 1500
    Threads: 1
    Collection: *Foreign
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *ForeignSmallDoc
  - Phase: 2..4
    Nop: true

- Name: LoadLocalSmallDoc100k
  Type: CrudActor
  Database: *db
  Threads: 10
  Phases:
  - *Nop
  - Repeat: 10000
    Threads: 1
    Collection: *LocalSmallDoc100k
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *LocalSmallDoc
  - Phase: 2..4
    Nop: true

- Name: LoadLocalSmallDoc300k
  Type: CrudActor
  Database: *db
  Threads: 10
  Phases:
  - *Nop
  - Repeat: 30000
    Threads: 1
    Collection: *LocalSmallDoc300k
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *LocalSmallDoc
  - Phase: 2..4
    Nop: true

- Name: LoadLocalSmallDoc500k
  Type: CrudActor
  Database: *db
  Threads: 10
  Phases:
  - *Nop
  - Repeat: 50000
    Threads: 1
    Collection: *LocalSmallDoc500k
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *LocalSmallDoc
  - Phase: 2..4
    Nop: true

- Name: LoadLocalSmallDoc700k
  Type: CrudActor
  Database: *db
  Threads: 10
  Phases:
  - *Nop
  - Repeat: 70000
    Threads: 1
    Collection: *LocalSmallDoc700k
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *LocalSmallDoc
  - Phase: 2..4
    Nop: true

- Name: LoadLocalLargeDoc100k
  Type: CrudActor
  Database: *db
  Threads: 10
  Phases:
  - *Nop
  - Repeat: 10000
    Threads: 1
    Collection: *LocalLargeDoc100k
    Operations:
    - OperationName: insertOne
      OperationCommand:
        Document: *LocalLargeDoc
  - Phase: 2..4
    Nop: true

# The 'SBE_Misc' actor measures the SBE HJ lookup performances and runs in the 2nd phase.
- Name: SBE_Misc
  Type: RunCommand
  Database: *db
  Phases:
  - *Nop
  - *Nop
  - Repeat: *TestRepeatCount
    Database: *db
    Operations: *TestOperations
  - *Nop
  - *Nop

# The 'TurnOffSBE' actor turns off the SBE engine so that the classic engine's NLJ performances can
# be measures and runs in the 3rd phase.
- Name: TurnOffSBE
  Type: AdminCommand
  Phases:
  - Phase: 0..2
    Nop: true
  - Repeat: 1
    Database: admin
    Operations:
    - OperationName: AdminCommand
      OperationCommand:
        setParameter: 1
        internalQueryForceClassicEngine: true
  - *Nop

# The 'Classic_Misc' actor measures the classic engine's NLJ performances and runs in the 4th phase.
- Name: Classic_Misc
  Type: RunCommand
  Database: *db
  Phases:
  - Phase: 0..3
    Nop: true
  - Repeat: *TestRepeatCount
    Database: *db
    Operations: *TestOperations

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone-all-feature-flags
