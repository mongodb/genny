SchemaVersion: 2018-07-01
Owner: "@mongodb/server-execution"
Description: >
 Create collection with multiple indexes and run queries with different selectivity on different
 indexes to test how efficiently multi planning can fix most selective index.

Keywords:
- indexes

GlobalDefaults:
  Database: &Database test
  Collection: &Collection Collection0
  Namespace: &Namespace test.Collection0
  DocumentCount: &docCount 10000
  MaxPhases: &MaxPhases 5

ValueGenerators:
- &Key {^FastRandomString: {length: 6, alphabet: "0123456789"}}
- &SmallKey {^Join: {array: ["1", {^FastRandomString: {length: 5, alphabet: "0123456789"}}]}}
- &BigKey {^Join: {array: ["8", {^FastRandomString: {length: 5, alphabet: "0123456789"}}]}}
- &SelectiveQuery {^Choose: {
  from: [
    {$gte: *BigKey},
    {$lte: *SmallKey}
  ]
}}
- &NonSelectiveQuery {^Choose: {
  from: [
    {$gte: *SmallKey},
    {$lte: *BigKey}
  ]
}}

Actors:
- Name: RecreateCollection
  Type: RunCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        Operations:
        - OperationName: RunCommand
          OperationCommand:
            drop: *Collection
        - OperationName: RunCommand
          OperationCommand:
            createIndexes: *Collection
            indexes:
            - key:
                a: 1
              name: a_1
            - key:
                b: 1
              name: b_1
            - key:
                c: 1
              name: c_1

- Name: DisablePlanCache
  Type: AdminCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Operations:
        - OperationName: AdminCommand
          OperationCommand:
            setParameter: 1
            internalQueryDisablePlanCache: true

- Name: Insert
  Type: Loader
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [2]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        Threads: 1
        CollectionCount: 1
        DocumentCount: *docCount
        BatchSize: 1000
        Document:
          a: *Key
          b: *Key
          c: *Key

- Name: Lookup
  Type: CrudActor
  Database: *Database
  Threads: 4
  Phases:
  - &Nop {Nop: true}
  - *Nop
  - *Nop
  - Duration: 1 minute
    Collection: *Collection
    Operations:
    - OperationName: find
      OperationMetricsName: FindWithMostSelectiveA
      OperationCommand:
        Filter: {
          a: *SelectiveQuery,
          b: *NonSelectiveQuery,
          c: *NonSelectiveQuery
        }
  - Duration: 1 minute
    Collection: *Collection
    Operations:
    - OperationName: find
      OperationMetricsName: FindWithMostSelectiveB
      OperationCommand:
        Filter: {
          a: *NonSelectiveQuery,
          b: *SelectiveQuery,
          c: *NonSelectiveQuery
        }
  - Duration: 1 minute
    Collection: *Collection
    Operations:
    - OperationName: find
      OperationMetricsName: FindWithMostSelectiveC
      OperationCommand:
        Filter: {
          a: *NonSelectiveQuery,
          b: *SelectiveQuery,
          c: *NonSelectiveQuery
        }

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone
      - standalone-all-feature-flags
      - replica
      - replica-all-feature-flags
    branch_name:
      $gte: v6.0

