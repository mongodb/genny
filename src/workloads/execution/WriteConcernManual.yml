SchemaVersion: 2018-07-01
Owner: "@TODO"
Description: >
  TODO

Actors:
- Name: Configure replication on secondary
  Type: ExternalScriptRunner
  Threads: 1
  Phases:
  # Turn off replication
  - Repeat: 1
    Command: "sh"
    Script: |
      mongosh md0:27017/admin --eval "db.setProfilingLevel(0, -1)"
      mongosh md1:27017/admin --eval "db.adminCommand({configureFailPoint: 'stopReplProducer', mode: 'alwaysOn'})"
  # Sleep 10s to ensure flag is set
  - Repeat: 1
    Command: "sh"
    Script: |
      sleep 10
  # Inserts with w:1 --> work fine
  - Repeat: 1
    Command: "sh"
    Script: |
      mongosh md0:27017/test --eval "db.bench.collection.insertOne({a:1}, { writeConcern: {w: 1} })"
  # No write concern --> works because default is 1
  - Repeat: 1
    Command: "sh"
    Script: |
      mongosh md0:27017/test --eval "db.bench.collection.insertOne({a:1})"
  # Inserts with w: majority --> stalls
  - Repeat: 1
    Command: "sh"
    Script: |
      mongosh md0:27017/test --eval "db.bench.collection.insertOne({a:1}, { writeConcern: {w: 'majority'} })"
  # Inserts with w:2 --> stall
  - Repeat: 1
    Command: "sh"
    Script: |
      mongosh md0:27017/test --eval "db.bench.collection.insertOne({a:1}, { writeConcern: {w: '2', wtimeout: 10000} })"
  # Turn on replication
  - Repeat: 1
    Command: "sh"
    Script: |
      mongosh md1:27017/admin --eval "db.adminCommand({configureFailPoint: 'stopReplProducer', mode: 'off'})"

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - replica-2node
    branch_name:
      $neq:
      - v4.0
