SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  This workload tests the performance of conjunctive collection scan queries where the order of
  predicates matters due to selectivity of the predicates.

GlobalDefaults:
  Database: &Database {^Parameter: {Name: Database, Default: unused}}
  DocumentCount: &DocumentCount {^Parameter: {Name: DocumentCount, Default: -1}}
  Repeat: &Repeat {^Parameter: {Name: Repeat, Default: -1}}
  Collection: &Collection Collection0
  MaxPhases: &MaxPhases 31
  Billion: &Billion 1_000_000_000
  NegativeBillion: &NegativeBillion -1_000_000_000

ActorTemplates:
- TemplateName: FindQueryTemplate
  Config:
    Name: {^Parameter: {Name: "Name", Default: "unused"}}
    Type: CrudActor
    Database: *Database
    Threads: 1
    Phases:
      OnlyActiveInPhases:
        Active: [{^Parameter: {Name: "ActivePhase", Default: -1}}]
        NopInPhasesUpTo: *MaxPhases
        PhaseConfig:
          Repeat: *Repeat
          Collection: *Collection
          Operations:
          - OperationName: find
            OperationCommand:
              Filter: {^Parameter: {Name: "Filter", Default: {invalid: "invalid"}}}

Actors:
- Name: ClearCollection
  Type: CrudActor
  Database: *Database
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Threads: 1
        Collection: *Collection
        Operations:
        - OperationName: drop

- Name: InsertData
  Type: Loader
  Threads: 4
  Phases:
    OnlyActiveInPhases:
      Active: [1]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Database: *Database
        MultipleThreadsPerCollection: true
        CollectionCount: 1
        DocumentCount: *DocumentCount
        BatchSize: 1000
        Document:
          {
            onePercentNull: {^Choose: {from: ["non-null", null], weights: [99, 1]}},
            tenPercentNull: {^Choose: {from: ["non-null", null], weights: [90, 10]}},
            quarterNull: {^Choose: {from: ["non-null", null], weights: [75, 25]}},
            onePercentPositiveInt: {^Choose: {
              from: &PositiveAndNegativeIntegers [{^Inc: {start: 1, step: 1}}, {^Inc: {start: -1, step: -1}}], 
              weights: [1, 99]
            }},
            tenPercentPositiveInt: {^Choose: {from: *PositiveAndNegativeIntegers, weights: [10, 90]}},
            quarterPositiveInt: {^Choose: {from: *PositiveAndNegativeIntegers, weights: [25, 75]}},
            halfPositiveInt: {^Choose: {from: *PositiveAndNegativeIntegers, weights: [50, 50]}},
            quarterNegativeInt: {^Choose: {from: *PositiveAndNegativeIntegers, weights: [75, 25]}},
            tenPercentNegativeInt: {^Choose: {from: *PositiveAndNegativeIntegers, weights: [90, 10]}},
            onePercentNegativeInt: {^Choose: {from: *PositiveAndNegativeIntegers, weights: [99, 1]}},
            nested: [
              {
                onePercentNull: {^Choose: {from: ["non-null", null], weights: [99, 1]}},
                tenPercentNull: {^Choose: {from: ["non-null", null], weights: [90, 10]}},
                quarterNull: {^Choose: {from: ["non-null", null], weights: [75, 25]}},
                onePercentPositiveInt: {^Choose: {from: *PositiveAndNegativeIntegers, weights: [1, 99]}},
                tenPercentPositiveInt: {^Choose: {from: *PositiveAndNegativeIntegers, weights: [10, 90]}},
                quarterPositiveInt: {^Choose: {from: *PositiveAndNegativeIntegers, weights: [25, 75]}},
                halfPositiveInt: {^Choose: {from: *PositiveAndNegativeIntegers, weights: [50, 50]}},
                quarterNegativeInt: {^Choose: {from: *PositiveAndNegativeIntegers, weights: [75, 25]}},
                tenPercentNegativeInt: {^Choose: {from: *PositiveAndNegativeIntegers, weights: [90, 10]}},
                onePercentNegativeInt: {^Choose: {from: *PositiveAndNegativeIntegers, weights: [99, 1]}},
              }
            ]
          }

- Name: Quiesce
  Type: QuiesceActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [2]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Threads: 1

# In actors' names, a 'good case' means that the ordering of predicates defined by actual
# selectivities matches the ordering defined by heuristic selectivity estimation. Heuristic CE 
# defines the following selectivity order for predicates:
# $eq < closed range (e.g. {$gt: 10, $lte: 20}) < open range (e.g. {$gt: 10}) < $ne

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: HighSelHeuristicGoodTwoClauses
      ActivePhase: 3
      Filter:
        # Here (0, 1e9) is the most selective predicate, both in reality and according to heuristic CE.
        # Note that without predicate reordering, predicates are ordered by first comparing field names.
        &HighSelHeuristicGoodTwoClauses {
          onePercentPositiveInt: {$gt: 0, $lt: *Billion}, # Selectivity = .01
          onePercentNegativeInt: {$gt: 0}, # Selectivity = .99
        }

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: MediumSelHeuristicGoodTwoClauses
      ActivePhase: 4
      Filter:
        &MediumSelHeuristicGoodTwoClauses {
          tenPercentPositiveInt: {$gt: 0, $lt: *Billion}, # Selectivity = .1
          tenPercentNegativeInt: {$gt: 0}, # Selectivity = .9
        }

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: LowSelHeuristicGoodTwoClauses
      ActivePhase: 5
      Filter:
        &LowSelHeuristicGoodTwoClauses {
          quarterPositiveInt: {$gt: 0, $lt: *Billion}, # Selectivity = .25
          quarterNegativeInt: {$gt: 0}, # Selectivity = .75
        }

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: HighSelHeuristicBadTwoClauses
      ActivePhase: 6
      Filter:
        # Here (-1e9, 0) is the most selective predicate according to heuristic CE. However, (-inf, 0)
        # is more selective in reality.
        &HighSelHeuristicBadTwoClauses {
          onePercentPositiveInt: {$gt: *NegativeBillion, $lt: 0}, # Selectivity = .99
          onePercentNegativeInt: {$lt: 0}, # Selectivity = .01
        }

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: MediumSelHeuristicBadTwoClauses
      ActivePhase: 7
      Filter:
        &MediumSelHeuristicBadTwoClauses {
          tenPercentPositiveInt: {$gt: *NegativeBillion, $lt: 0}, # Selectivity = .9
          tenPercentNegativeInt: {$lt: 0}, # Selectivity = .1
        }

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: LowSelHeuristicBadTwoClauses
      ActivePhase: 8
      Filter:
        &LowSelHeuristicBadTwoClauses {
          quarterPositiveInt: {$gt: *NegativeBillion, $lt: 0}, # Selectivity = .75
          quarterNegativeInt: {$lt: 0}, # Selectivity = .25
        }

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: HighSelHeuristicGoodFourClauses
      ActivePhase: 9
      Filter:
        &HighSelHeuristicGoodFourClauses {
          onePercentNull: null, # Selectivity = .01
          quarterPositiveInt: {$gt: 0, $lt: *Billion}, # Selectivity = .25
          quarterNegativeInt: {$gt: 0}, # Selectivity = .75
          tenPercentNull: {$ne: null}, # Selectivity = .9
        }

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: MediumSelHeuristicGoodFourClauses
      ActivePhase: 10
      Filter:
        &MediumSelHeuristicGoodFourClauses {
          tenPercentNull: null, # Selectivity = .1
          quarterPositiveInt: {$gt: 0, $lt: *Billion}, # Selectivity = .25
          quarterNegativeInt: {$gt: 0}, # Selectivity = .75
          onePercentNull: {$ne: null}, # Selectivity = .99
        }

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: LowSelHeuristicGoodFourClauses
      ActivePhase: 11
      Filter:
        &LowSelHeuristicGoodFourClauses {
          quarterNull: null, # Selectivity = .25
          halfPositiveInt: {$gt: 0, $lt: *Billion}, # Selectivity = .5
          quarterNegativeInt: {$gt: 0}, # Selectivity = .75
          onePercentNull: {$ne: null}, # Selectivity = .99
        }

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: HighSelHeuristicBadFourClauses
      ActivePhase: 12
      Filter:
        &HighSelHeuristicBadFourClauses {
          tenPercentNull: "non-null", # Selectivity = .9
          quarterPositiveInt: {$gt: *NegativeBillion, $lt: 0}, # Selectivity = .75
          quarterNegativeInt: {$lt: 0}, # Selectivity = .25
          onePercentNull: {$ne: "non-null"}, # Selectivity = .01
        }

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: MediumSelHeuristicBadFourClauses
      ActivePhase: 13
      Filter:
        &MediumSelHeuristicBadFourClauses {
          onePercentNull: "non-null", # Selectivity = .99
          quarterPositiveInt: {$gt: *NegativeBillion, $lt: 0}, # Selectivity = .75
          quarterNegativeInt: {$lt: 0}, # Selectivity = .25
          tenPercentNull: {$ne: "non-null"}, # Selectivity = .1
        }

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: LowSelHeuristicBadFourClauses
      ActivePhase: 14
      Filter:
        &LowSelHeuristicBadFourClauses {
          onePercentNull: "non-null", # Selectivity = .99
          quarterPositiveInt: {$gt: *NegativeBillion, $lt: 0}, # Selectivity = .75
          halfNegativeInt: {$lt: 0}, # Selectivity = .5
          quarterNull: {$ne: "non-null"}, # Selectivity = .25
        }

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: HighSelIndistinguishableByHeuristics
      ActivePhase: 15
      Filter:
        &HighSelIndistinguishableByHeuristics {
          onePercentPositiveInt: {$gt: 0}, # Selectivity = .01
          tenPercentPositiveInt: {$gt: 0}, # Selectivity = .1
          quarterPositiveInt: {$gt: 0}, # Selectivity = .25
          halfPositiveInt: {$gt: 0}, # Selectivity = .5
          quarterNegativeInt: {$gt: 0}, # Selectivity = .75
          tenPercentNegativeInt: {$gt: 0}, # Selectivity = .9
          onePercentNegativeInt: {$gt: 0}, # Selectivity = .99
        }

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: MediumSelIndistinguishableByHeuristics
      ActivePhase: 16
      Filter:
        &MediumSelIndistinguishableByHeuristics {
          tenPercentPositiveInt: {$gt: 0}, # Selectivity = .1
          quarterPositiveInt: {$gt: 0}, # Selectivity = .25
          halfPositiveInt: {$gt: 0}, # Selectivity = .5
          quarterNegativeInt: {$gt: 0}, # Selectivity = .75
          tenPercentNegativeInt: {$gt: 0}, # Selectivity = .9
          onePercentNegativeInt: {$gt: 0}, # Selectivity = .99
          onePercentPositiveInt: {$lt: 0}, # Selectivity = .99
        }

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: LowSelIndistinguishableByHeuristics
      ActivePhase: 16
      Filter:
        &LowSelIndistinguishableByHeuristics {
          quarterPositiveInt: {$gt: 0}, # Selectivity = .25
          halfPositiveInt: {$gt: 0}, # Selectivity = .5
          quarterNegativeInt: {$gt: 0}, # Selectivity = .75
          tenPercentNegativeInt: {$gt: 0}, # Selectivity = .9
          onePercentNegativeInt: {$gt: 0}, # Selectivity = .99
          tenPercentPositiveInt: {$lt: 0}, # Selectivity = .9
          onePercentPositiveInt: {$lt: 0}, # Selectivity = .99
        }

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: ElemMatchHighSelHeuristicGoodTwoClauses
      ActivePhase: 17
      Filter:
        {nested: {$elemMatch: *HighSelHeuristicGoodTwoClauses}}

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: ElemMatchMediumSelHeuristicGoodTwoClauses
      ActivePhase: 18
      Filter:
        {nested: {$elemMatch: *MediumSelHeuristicGoodTwoClauses}}

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: ElemMatchLowSelHeuristicGoodTwoClauses
      ActivePhase: 19
      Filter:
        {nested: {$elemMatch: *LowSelHeuristicGoodTwoClauses}}

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: ElemMatchHighSelHeuristicBadTwoClauses
      ActivePhase: 20
      Filter:
        {nested: {$elemMatch: *HighSelHeuristicBadTwoClauses}}

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: ElemMatchMediumSelHeuristicBadTwoClauses
      ActivePhase: 21
      Filter:
        {nested: {$elemMatch: *MediumSelHeuristicBadTwoClauses}}

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: ElemMatchLowSelHeuristicBadTwoClauses
      ActivePhase: 22
      Filter:
        {nested: {$elemMatch: *LowSelHeuristicBadTwoClauses}}

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: ElemMatchHighSelHeuristicGoodFourClauses
      ActivePhase: 23
      Filter:
        {nested: {$elemMatch: *HighSelHeuristicGoodFourClauses}}

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: ElemMatchMediumSelHeuristicGoodFourClauses
      ActivePhase: 24
      Filter:
        {nested: {$elemMatch: *MediumSelHeuristicGoodFourClauses}}

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: ElemMatchLowSelHeuristicGoodFourClauses
      ActivePhase: 25
      Filter:
        {nested: {$elemMatch: *LowSelHeuristicGoodFourClauses}}

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: ElemMatchHighSelHeuristicBadFourClauses
      ActivePhase: 26
      Filter:
        {nested: {$elemMatch: *HighSelHeuristicBadFourClauses}}

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: ElemMatchMediumSelHeuristicBadFourClauses
      ActivePhase: 27
      Filter:
        {nested: {$elemMatch: *MediumSelHeuristicBadFourClauses}}

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: ElemMatchLowSelHeuristicBadFourClauses
      ActivePhase: 28
      Filter:
        {nested: {$elemMatch: *LowSelHeuristicBadFourClauses}}

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: ElemMatchHighSelIndistinguishableByHeuristics
      ActivePhase: 29
      Filter:
        {nested: {$elemMatch: *HighSelIndistinguishableByHeuristics}}

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: ElemMatchMediumSelIndistinguishableByHeuristics
      ActivePhase: 30
      Filter:
        {nested: {$elemMatch: *MediumSelIndistinguishableByHeuristics}}

- ActorFromTemplate:
    TemplateName: FindQueryTemplate
    TemplateParameters:
      Name: ElemMatchLowSelIndistinguishableByHeuristics
      ActivePhase: 31
      Filter:
        {nested: {$elemMatch: *LowSelIndistinguishableByHeuristics}}
