SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  This file defines templates to use in multiplanner performance tests.

QueryKnobTemplate:
  Name: SetQueryKnobs
  Type: RunCommand
  Threads: 1
  Phases:
    OnlyActiveInPhases:
      Active: {^Parameter: {Name: "active", Default: [0]}}
      NopInPhasesUpTo: {^Parameter: {Name: "nopInPhasesUpTo", Default: 99}}
      PhaseConfig:
        Repeat: 1
        Database: admin
        Operations:
        - OperationName: RunCommand
          OperationCommand:
            setParameter: {^Parameter: {Name: "collection", Default: Collection0}}
            # Disable the plan cache so we multiplan on every request.
            internalQueryDisablePlanCache: true
            # Disable index intersection so we can more easily control the number of competing plans.
            # We should get one plan per index.
            internalQueryPlannerEnableIndexIntersection: false

InsertTemplate:
  Name: CreateDataset
  Type: Loader
  Threads: {^Parameter: {Name: "threadsA", Default: 1}}
  Database: &db {^Parameter: {Name: "database", Default: test}}
  Phases:
    OnlyActiveInPhases:
      Active: {^Parameter: {Name: "active", Default: [0]}}
      NopInPhasesUpTo: {^Parameter: {Name: "nopInPhasesUpTo", Default: 99}}
      PhaseConfig:
        Threads: {^Parameter: {Name: "threadsB", Default: 1}}
        Repeat: {^Parameter: {Name: "repeat", Default: 10}}
        Database: *db
        Collection: {^Parameter: {Name: "collection", Default: Collection0}}
        CollectionCount: 1
        DocumentCount: &docCount {^Parameter: {Name: "docCount", Default: 1000}}
        BatchSize: 1000
        Document:
          # Genny's random generators appear to be repeatable, so we might as well
          # make '_id' explicit to make the overall dataset repeatable. Omitting
          # '_id' would make it auto-generated based on a timestamp.
          _id: {^Inc: {start: 0}}
          x1: &distribution {^RandomDouble: {distribution: uniform, min: 0.0, max: 1.0}}
          x2: *distribution
          x3: *distribution
          x4: *distribution
          x5: *distribution
          x6: *distribution
          x7: *distribution
          x8: *distribution
          x9: *distribution
          x10: *distribution
          x11: *distribution
          x12: *distribution
          x13: *distribution
          x14: *distribution
          x15: *distribution
          x16: *distribution
          x17: *distribution
          x18: *distribution
          x19: *distribution
          x20: *distribution
          x21: *distribution
          x22: *distribution
          x23: *distribution
          x24: *distribution
          x25: *distribution
          x26: *distribution
          x27: *distribution
          x28: *distribution
          x29: *distribution
          x30: *distribution
          x31: *distribution
          x32: *distribution
          x33: *distribution
          x34: *distribution
          x35: *distribution
          x36: *distribution
          x37: *distribution
          x38: *distribution
          x39: *distribution
          x40: *distribution
          x41: *distribution
          x42: *distribution
          x43: *distribution
          x44: *distribution
          x45: *distribution
          x46: *distribution
          x47: *distribution
          x48: *distribution
          x49: *distribution
          x50: *distribution
          x51: *distribution
          x52: *distribution
          x53: *distribution
          x54: *distribution
          x55: *distribution
          x56: *distribution
          x57: *distribution
          x58: *distribution
          x59: *distribution
          x60: *distribution
          x61: *distribution
          x62: *distribution
          x63: *distribution
        Indexes: 
          {^Parameter: {Name: "indexes", Default: []}}

QueryTemplate:
  Name: RunQueries
  Type: CrudActor
  Threads: 1
  Phases:
    OnlyActiveInPhases: 
      Active: {^Parameter: {Name: "active", Default: [0]}}
      NopInPhasesUpTo: {^Parameter: {Name: "nopInPhasesUpTo", Default: 99}}
      PhaseConfig:
        Repeat: {^Parameter: {Name: "repeat", Default: 10}}
        Database: {^Parameter: {Name: "database", Default: test}}
        Collection: {^Parameter: {Name: "collection", Default: Collection0}}
        Operations:
          - OperationName: find
            OperationCommand:
              Filter: {
                x1: {$lt: {^Parameter: {Name: "selectivity", Default: 1}}},
                x2: {$lte: 1},
                x3: {$lte: 1},
                x4: {$lte: 1},
                x5: {$lte: 1},
                x6: {$lte: 1},
                x7: {$lte: 1},
                x8: {$lte: 1},
                x9: {$lte: 1},
                x10: {$lte: 1},
                x11: {$lte: 1},
                x12: {$lte: 1},
                x13: {$lte: 1},
                x14: {$lte: 1},
                x15: {$lte: 1},
                x16: {$lte: 1},
                x17: {$lte: 1},
                x18: {$lte: 1},
                x19: {$lte: 1},
                x20: {$lte: 1},
                x21: {$lte: 1},
                x22: {$lte: 1},
                x23: {$lte: 1},
                x24: {$lte: 1},
                x25: {$lte: 1},
                x26: {$lte: 1},
                x27: {$lte: 1},
                x28: {$lte: 1},
                x29: {$lte: 1},
                x30: {$lte: 1},
                x31: {$lte: 1},
                x32: {$lte: 1},
                x33: {$lte: 1},
                x34: {$lte: 1},
                x35: {$lte: 1},
                x36: {$lte: 1},
                x37: {$lte: 1},
                x38: {$lte: 1},
                x39: {$lte: 1},
                x40: {$lte: 1},
                x41: {$lte: 1},
                x42: {$lte: 1},
                x43: {$lte: 1},
                x44: {$lte: 1},
                x45: {$lte: 1},
                x46: {$lte: 1},
                x47: {$lte: 1},
                x48: {$lte: 1},
                x49: {$lte: 1},
                x50: {$lte: 1},
                x51: {$lte: 1},
                x52: {$lte: 1},
                x53: {$lte: 1},
                x54: {$lte: 1},
                x55: {$lte: 1},
                x56: {$lte: 1},
                x57: {$lte: 1},
                x58: {$lte: 1},
                x59: {$lte: 1},
                x60: {$lte: 1},
                x61: {$lte: 1},
                x62: {$lte: 1},
                x63: {$lte: 1}
              }
