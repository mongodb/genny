SchemaVersion: 2018-07-01
Owner: "@mongodb/product-query"
Description: |
  Run TPC-H query 11 against the normalized schema. Using an 'executionStats' explain causes each command to run its execution plan until no
  documents remain, which ensures that the query executes in its entirety.

batchSize: &batchSize 101  # The default batch size.
query11Nation: &query11Nation "GERMANY"
query11Fraction: &query11Fraction 0.0001

TPCHNormalizedQuery11:
  Repeat: 1
  Database: tpch
  Operations:
  - OperationMetricsName: Query11
    OperationName: RunCommand
    OperationCommand:
      explain:
        aggregate: partsupp
        pipeline:
          [
            {$lookup: {
              from: "supplier",
              localField: "ps_suppkey",
              foreignField: "s_suppkey",
              as: "supplier"}},
            {$unwind: "$supplier"},
            {$lookup: {
              from: "nation",
              localField: "supplier.s_nationkey",
              foreignField: "n_nationkey",
              pipeline: [{$match: {n_name: {^Parameter: {Name: "Query11Nation", Default: *query11Nation}}}}],
              as: "nation"}},
            {$unwind: "$nation"},
            {$addFields: {total_cost: {$multiply: ["$ps_supplycost", "$ps_availqty"]}}},
            {$group: {
              _id: "$ps_partkey",
              value: {$sum: "$total_cost"}}},
            {$group: {
              _id: 0,
              groups: {$push: {ps_partkey: "$_id", value: "$value"}},
              total_cost: {$sum: "$value"}}},
            {$addFields: {
              threshold: {$multiply: ["$total_cost", {^Parameter: {Name: "Query11Fraction", Default: *query11Fraction}}]}}},
            {$unwind: "$groups"},
            {$project: {
              ps_partkey: "$groups.ps_partkey",
              value: "$groups.value",
              threshold: 1}},
            {$match: {$expr: {$gt: ["$value", "$threshold"]}}},
            {$project: {_id: 0, ps_partkey: 1, value: 1}},
            {$sort: {value: -1}},
          ]
        cursor: {batchSize: *batchSize}
        allowDiskUse: true
      verbosity:
        executionStats
